var lvl1_nerf=`
 c
lhHhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhH r r
 r          rC                        r r
 r          r                         r r
 r          rrrrr rrrrrrrrrrrrrrrrrrrrr r
lr          r                         r r
 r          r                         r r
 r          r    r rr  rrrrrrrrr  rrrrr r
 r          r    r r               cr r r
lr          rrrr r r                r r r
 r               r r rrrrrrrrrrrrrr r r r
 r               r r                  r r
 rrrrrrrrrrrr    r r                  r r
lrCc        r  rrr rrrrrrrrrrrrrrrrrr r r
 r             r                      r r
 r             rC                    cr r
 rrrrrrrrrrrrrrr                      r r
lrcccccccccccccr                      r r
  cccccccccccccr                      r r
  cccccccccccccr                      r r
 r rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr r
 r                                      r
 r                                      r
 r                                      r
 rr            l           l     l      r
 rrl rl rl rl rl rl   rrl rl rl rl rll rr

 llllllllllllllllllllllllllllllllllllllll

 CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`
var lvl1=
`                                zzzzzzzz

 v                                      v
 r    e    e     e     e     e          vZ
 rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr  r
 r                                    r r
 r                                    r  r
 r                                    r   r
 r                                    r    r
 r   rrrrrrrrrrrr rrrrrrrrrrrrrrrrrrrrr     r
 r          r     v                   r r    r
 r          rvvvv                             r
 r          r    rvrrvrrrrrrrrrrrvrrrrrvrr     r
 r          r    r r               cr r r r     r
 r          rrrr r r                r r r  r     r
 r               r r rrrrrrrrrrrrrrrr r r   l    lr
 rrrrrrrr        r r                  r r    r   llr
 r      rrrr     r r                  r r         llr
 rCc        rrrrr   rrrrrrrrrrrrrrrrr r r        l  lr
 r                                    r r       r
 r      z    e v z                    r r      l
 rrrrrrrrrrrrrrr z     z z z z z z  r r r     r
 rcccccccccccccr z                    r r    l
  cccccccccccccr z    z z z z z z z   r r   r
  C   C   C   Cr  z                  lr r  r
 r rrrrrrrrrrrrrllrrrrrrrrrrrrrrrrrrrrr r
 r                                      r
 r                                       r
 rzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz    r
 rr            l           l     l                         l
 rrl rl rl rl rl rl   rrl rl rl rl rll rrrrrrrrrrrrlllllllll
v
v llllIIIlllIIIllllIIIlllllIIIlllIIIlIIIll
v
vCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCn
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`

var lvl2 = `
l
l
l
f
f
f
f
l
l
l     s
rrrrrrrrr          r       r       r       r       r       r
r
r
r                                                                  r
r
r
r                                                                        r
r
r      ie
lfllllllllllllllllllllllllllllllllGffGlllllllllllllllllllllllllllll llllllllllllllr            l
                                                                    v                          l
                                                                    v                          l
                     c    c                                         v                  c       l
           cll      c  c  l  c                                      v                  c       l
    c  c l    l        l     l  c       zlz lz  z  zl z  zllllcz  zl                  c        l
    l   l      c  lz   l     l  c        l  lc   c     c  c c   c   c l  l  l  l  l  l c       l
 n               l  z   ccc     llllzclzc  c     lz    lz       lz lz  c  c  c  c  c r cǝ      l
 r lrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`
var ethan_lvl=
`


                                   rrrr   rrrrrrrrrrrrrrrrrrrrrrrrr l
                                   r                   r            l
                                   r                   r            l
                                   r                   r            l
                                   r                   r            l
                                   r                   r            l
                                   ree                 r            l
                                   r rrrrrrrrrrrrrrrrrrr
                                   r
                                   rrrrrrrrrrrrrrrrrrrrrrrr    frrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr         rrrrffrrr c


                                                   rrrrrrrrr


l
l                                                rrrr
l                                                        rrrrr
l          l
l          l
l          l                                                     r
r   e        ǝ ǝ ǝ ǝ ǝ ǝ ǝ    zrzzcccc                     rrrrrrr
rrrrrrr  rrrrrrrrrrrrrrrrr z  rllllllr                    r
f                           zrllllllll                  r
f                          zr             r       rrrrrrrrr
r                         zr
r                        zr             l
r                       zrcccccccccc rrrr
r  r                   zrccccccccccccr
rrrrrrrrrrrrrrrrrrrrrrrrrr rrrrrrrrrrr       IIIIIIIIIIIIII  I
I                                                            I
I                                                        rIIII
I                                                        r             iiiiiiiiiiii
I                                                        r
I                           lllllllllllFFFFFFFFFrrrrrrrrrr
I        iiiii    rccccccc r  lrr                                                     iiiiiiiiiiiii
    CCCCCCC i    rrrrrrrrrr
     iiiii ii

    i                          c                                                                    i i
                       rrr  cccrr                                                                   i i
            ---rccc r ǝǝǝǝǝ rrr
r-r    eee    rrrrrrrrrrrrrr       r                                                                   CCCCCCC
rrrrrrrrrrrrrrrr
rcccccccccccccc                r   ee   r                                                            rrrrrrrrrrrrrrrrrr
rcccccccccccccc  l              rrrrrrrr
r CCCCCCCCCCCCCCC            r
r          e        r  r rrr
rrrrrrrrrrrrrrrrrrrr






                                                                                                                        iiiiiiiiiiiiiiiiiiiiir





                                                                                                                                             iiiiiiii


                                                         CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
                                                        rrrrrrrrrrrrrrrrrrlllllllrlllllrrrrr         CCCCCCCCCCCCCCCCCC
iiiiiiiiiiiiii                              r       r                                                rrrrrrrrrrrrrrrrrr
                 cccccccccc       r
                 rrrrrrrrrr                                                                                                                         iiiiii



                                                                                                                                                           iiiir



                                                                                                                            i                    ee         i
                                                                                                                            iiiiiiiiiiiiiiiiiiiiiiiiifiiiiiii
                                                                                                                            i                              i
                                                                                                                            i CCCCCCCCCCCCCCCCCCCCCCCCCC   iC
                                                                                                                            iiiiiiiiiiiiiiiiiiiiiiiiiiiiiIIiii








                                                                                            r                         r
                                                                                            rrrrrrffrrrrrrrrrrrrrrrrrrr
                                                                                            r                         r


                                                                                            rCCCCCCCCCCCCCCCCCCCCCCCCCr
                                                                                            rrrrrrrrrrrrrrrrrrrrrrrrr r
`

var the_plains = `
                                                                      l
                                                                      l
                                                                      l
                                                                      l
         l                                                            l
         l                                                            l
         l                                                   llllll   l
r        l                                           cl    rl      r  l
r                                                    rl    r       r  l  C
r                                                     l    r     r r  l lrrrr
r                cl                                  cl    r     r r        r
r        c       rl       l                          rl   rr     r r        r
r        l        l      l l                          l    r     r rrrrrrrr r
r        r        l     lCcCl                         l    r    rr                                                    r
r        r        l  c  lC Cl k  c   c   c   c      k l c  r     r              k        c        c        ckl   l k  lCl  n
rrrrrrrrrrrrrrrrrrrrrrrrr   rrr rrlllrlllrlllrrrr rrrrrrrrrr   crrrrrrrrrrrrrrrrrllllllllrllllllllrllllllllrrrrrrrrrrrrrrrrr
                        r       r               l l            r
                        r       r               l Cl          l
                        r       r               l  Cl         l
                        rrrrrrrrr               l   Cl      cl
                                                l           r
                                                l          l
                                                l          l
                                                l        cl
                                                l        r
                                                 l      l
                                                  lccccCl
                                                   lrrrl
`

var actual_maze = `
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrl
r                                       r
r                                       rr
r              rrr rrrrrrrrrrrrrrrr rrrrr
r                r rCC                  r
r    s           r rCC                  rr
rrrrrrrrrrrrrrrr r rrlrrlrrlrrrrrrrrrrr r
               r r                    r r
               r rCcccccccccccccccccccr r
               r rrrrrrrrrrrrrrrrrrrllr rrr
               r                      r   r
       l       r                      r   r
       lr      r                      rr  rr  cccc cccc cccc cccc cccc
       l       r                      r   rrCv e     e           e    v
       l       r C    c     c    c   cr   rrrrrrrrrrrrrrrrrrrrrrrrrrrr
       lr      rlrllllrlllllrllllrlllrr r v                          r
       l                                r v                          r
       l                                rCv   e                      r
s      l                                rrrrrrrr                     v  r
l rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr       rz     l      ele     v r
l                                                rrrrrrrrrrrrrrrrrrrrrrr
l                                         rlr                         r
rrrrrrrrrrrrrrr rrrrrrrrrrrrrrrrrrrrrrrrrrlClr c c c                 sr
r                                             rrrrrrrrrrrrrrrrrrrrrrrrr
rc c c c c c c c c c C c C c C c C c C c C c
rrrrrrrrrrrrrrrrrrrrrrrr rrrrrrrrrrrrrrrrrrrrrr
r                                             r r rrrrrrrrrrrrrrrrrrrrrrrrrrrr
r                       C                     r r                            r
r rrrrrrrrrrrrrrrrrrrrrr rrrrrrrrrrrrrrrrrrrr r r          rrrrr             r
r                                               rrr rrrrrr r           r rrr rrrrrrrrrrrrrr
r                                           c   r        r r     rrrrrrr r                r
rrrrrrrrrrrrrrrrrrrrrrrlllrrrrrrrrrrrrrrrrrrrrrrrc      lr   rrrr        r                r
                                            r    rrrrrr rr   r           r                r
                                            r         r rrrrrc    rrrrrrrrFFFFFFFFFFFFFFFFr
                                            rCCCCCCCCCCCr      r         r
                                            rCCCCCCCCCCCr       r        r
                                            r           l       rrrrrrrr r
                                            r           lCCCCCCCCCCCCCCr r
                                            rrrrrrrrrrrrrrrrrr         r r
                                                        r              r r
                                                        r     c c c c cr rCC
                                                        r    rrrrrrrrrrr rrrlllllllllllllll
                                                        r              rCCCl
                                                        r         cccccrCCnl
                                                        r              rrrrr
                                                        r              r
                                                        r c c c c c c cr
                                                        rrrrrrrrrrrrrrrr
`

var training = `
r           s
rrrrrrrrrrrrrllrrrr                                r
                    ccccccccs                      r
                    rrrrrrrrr                      r
                                                   r
                                r    e r   c      srccc
                                rrrrrrrrrrrr      rrjjjr
                                                       r
                                                       r
                                                       r
                                                 rrrrrrr
                                                               s
                                                             rrrSSSSS     s
                                                                        rrrrrr
                                                                          b  r
                                                                             r
                                                                        rrrrrrrr

                                                                                 s  n
                                                                                rrrrrrr
`

var tinymaze = `
r                c
r                r
r                r              c
r                r     e        r
r                rvrrrrrrrrrvrrrr
r    c                     r                     n
r    r       e           vcr  c    lll      rrrrr
rrrrrrrrrrrrrrvrrrrrrrrrrr rrrrrrrrrrr   e  r
                                     rrrrrrrr
        c       r          e  vcr
        rrrrrrrrrrrrrrrrrrrrrrr r
                              rlr
`

var fortress = `
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
r                                                  r
r                                                  r
r                                                  r
r           c         c         c        c         r
r    r      l        ele        l       ele     l nr
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`

var office = `
       llllllllrrrrrrrrnr
       r               Cr
       r               Cr
       r               Cr
       r       l       rr
       r v         e   rr
       rjrrrrrrrrrrrrrrrr
       r  E             r
       r         e      r
       rvvvvvvvvvvvvvvvvr
       rr               r
       rr l    l    l   r
       rrrrrrrrrrrrrrrr r
       r          b     r
       r v              r
       r v              r
       r v             rr
       r v             rr
       rjrrrrrrrrrrrrrrrr
       rC               r
       rC               r
       r                r
       rr  E            r
       rrvvlvvvvlvvvvlvvr
       rrrrrrrrrrrrrrrrjr
       r                r
       r                r
       r               Cr
       r               rr
       r  e   e   e    rr
       rjrrrrrrrrrrrrrrrr
       r                r
       r                r
       rc               r
       rr               r
       rr    e     e    r
       rrrrrrrrrrrrrrrrjr
       r                r
       r                r
       r               cr
                       rr
    s  v      e        rr
rrrrrrrrrrrrrrrrrrrrrrrrr
`

var platformer_robotics_competition = `
r            l
r
r            c               22C 22  22  llc                       CCC
r                            rrrrrrrrrrrrrr  333   333   333   333 rrr
r                          rrr
r
r     c      l  22222  c
rrrrrrrrlllrrrrrrrrrrrrrrrr
                         r
                         r
                         r
                         r
                         r
                         r
                         rc
                         rc
                         rllrrrrrrrrrr

`;

var new_features_wonderland = `
            r
            r
            r               r
            r               r
            r               r
r           rrjjrrSSSSS SSSSS
r                r         v
r                r         vb
rSSSSSSSSSSrrrrrrr         v
            b              v
                           v
                   rrrrrrttt
                   r                      r
    rjjSSSSSrrrrrrrr                r
    r              v            r   r       rr
                   v
                   v              r l
rrrrrttttttttttrrrrrrrrrrrrrrrrrrrrrrrrlllllllll  rr
                                      r
                                      r       n
                                      rrrrrrrrrrr
`;

var test = `
   rrrr

      b
rrrrrrrrr
`


window.phase = 1; // Unlock new levels by doing a good job.
window.levelsBeaten = 0; // Beat 2 levels to go to the next phase.
window.phases = [
    [
        {
            id: 7,
            name: "Training",
            func: function(){
                g.createByTileset(-2, 0, training, ["Look - lava! Sail over it with the 'up' and 'right' keys to avoid dying.", "As you can see, these are coins. Run into them to claim them, you'll notice you gain a score counter!<br /> The moving lava below you will hurt you just as bad as normal lava, so you should make sure to dodge it when you try to get the coin.", "The yellow blocks are jump-through platforms. You pass through them when you hit them from the bottom, but cannot go back!", "The blue tiles are ice. You'll find they're very slippery!", "This is a Bat. It clings to the cave walls until you drop next to it, then flies after you. It will kill you if it touches you.", "That's the end of the level. Run into it to exit back to the main menu, you'll notice this level will be gone! Once you beat every level on the menu, you will advance to phase 2 and more will appear."])
                g.createSign(1, 1, "Welcome to Platformer! This is a short, simple training level designed to get you on your feet.<br />What you have hovered is a sign. You should always hover them, they have useful information.<br />To start out, try moving the player with the left and right arrow keys", "Mouse Over Me")
            }
        },
        {
            id: 6,
            name: "Tiny Maze",
            func: function(){
                g.createByTileset(-2, 0, tinymaze);
            }
        },
        {
            id: 8,
            name: "Fortress",
            func: function(){
                g.createByTileset(-2, -5, fortress);
            }
        }
    ],
    [
        {
            id: 20,
            name: "New Features Wonderland",
            func: function(){
                g.createByTileset(-2, -5, new_features_wonderland)
            }
        },
        {
            id: 10,
            name: "Office",
            func: function(){
                g.createByTileset(0, 0, office, ["Well, it's bad. It looks like the lavas have taken over the office complex! Get to the top as fast as possible, so you can dump all of these lavas to Garbage Collection."]);
            }
        },
        {
            id: 5,
            name: "An Actual Maze This Time",
            func: function(){
                g.createByTileset(-5, -5, actual_maze, ["This one is a real maze. There is only one way out. Best of luck!", "Ah yes. Looks like you've found the less painful way out! I recommend you take a temporary detour, you'll get plenty coins that way.", "You didn't find the easy route at all. Haha!", "This is the end of the level."]);
            }
        }
    ],
    [
        {
            id: 1,
            name: "The Plains",
            func: function(){
                g.createByTileset(-5, 6, the_plains, ["Beware! This is a junction! The original creator designed what you will find if you go down, another designed what you will find if you keep on going this way. Neither play is revocable. Choose your poison!"]);
            }
        },
        {
            id: 4,
            name: "The Basement",
            func: function(){
                g.createByTileset(-3, -6, lvl2, ["You have a superpower. An extra jump! Slide off a platform without jumping and you can jump in mid-air to fly."]);
            }
        },
        {
            id: 2,
            name: "Labyrinth",
            func: function(){
                g.createByTileset(-3, -8, lvl1);
            }
        }
    ]
];
function getLevelmakerContext(g) {
    return {
        game: g,
        xOffset: 0,
        yOffset: 0,
        setOffset: function(x, y){
            this.xOffset = x;
            this.yOffset = y;
        },
        makeNormal: function(x, y, width, height){
            this.game.createBrick(x + this.xOffset, y + this.yOffset, width, height, "regular", "solid");
        },
        makeToothbrushTrap: function(x, y, prongs, alignment = 1){
            var height = prongs * 3 + 2;
            this.game.createBrick(x + this.xOffset, y - height + this.yOffset, 1, height, "lava", "killu");
            for (var i = 0; i < prongs; i ++){
                this.game.createBrick(x + alignment + this.xOffset, y - ((i + 1) * 3) - 1 + this.yOffset, 1, 1, "regular", "solid");
            }
        },
        makeSquaretrap: function(x, y, width, height){
            this.game.createBrick(x + this.xOffset,         y + this.yOffset - 1, 1, 1, "lava", "killu");
            this.game.createBrick(x + this.xOffset,         y + this.yOffset - 1 - height, 1, 1, "lava", "killu");
            this.game.createBrick(x + this.xOffset + width, y + this.yOffset - 1 - height, 1, 1, "lava", "killu");
            this.game.createBrick(x + this.xOffset + width, y + this.yOffset - 1, 1, 1, "lava", "killu");
        },
        makeCupTrap: function(x, y, width, height){
            this.makeNormal(x, y, 1, height);
            this.makeNormal(x, y + height, width - 1, 1);
            this.makeNormal(x + width, y, 1, height);
            this.game.createBrick(x - 1 + width + this.xOffset, y + this.yOffset + height, 2, 1, "lava", "killu");
        }
    }
}

function testLevel(context){
    context.setOffset(0, 4);
    context.makeNormal(0, 0, 14, 1);
    context.makeToothbrushTrap(4, 0, 1, -1);
    context.makeSquaretrap(8, 0, 3, 100);
    context.makeCupTrap(14, 0, 5, 5);
}

function loadPhase(phasenum){
    window.phases[phasenum - 1].forEach((item, i) => {
        console.log(item.name);
        var el = document.createElement("option");
        el.id = item.id.toString();
        el.value = item.id.toString();
        el.innerText = item.name;
        document.getElementById("dropdown").appendChild(el);
    });
    console.log(window.phases[phasenum - 1]);
}

class Brick{
    constructor(x,y,width,height, scale,renderclass,type,text,visibleText,probability){
        this.x1=x;
        this.y1=y;
        this.x2=x+width; // For collisions
        this.y2=y+height; // For collisions
        this.probprob = probability || 1;
        this.element=document.createElement("div");
        document.getElementById("game-main").appendChild(this.element);
        this.element.className=renderclass+" "+type+" "+" brick";
        this.element.style.width=width.toString()+"px";
        this.element.style.height=height.toString()+"px";
        this.element.style.left=this.x1.toString()+"px";
        this.element.style.top=this.y1.toString()+"px";
        var elem = document.createElement("div");
        this.element.appendChild(elem);
        if (text!=undefined){
            elem.innerHTML = text;
        }
        if (visibleText!=undefined){
            var elem = document.createElement("div");
            this.element.appendChild(elem);
            elem.innerHTML = visibleText;
        }
        this.type=type;
        this.needsDomRefresh = false;
        this.scale = scale;
    }
    move(xm,ym){
        this.x1+=xm;
        this.y1+=ym;
        this.x2+=xm;
        this.y2+=ym;
        this.needsDomRefresh = true;
    }
    apply(){
        if ((this.x1 < window.innerWidth || this.x2 > 0) && (this.y1 < window.innerHeight || this.y2 > 0) && this.needsDomRefresh){ // Don't do a dom operation unless the brick is visible
            this.element.style.left=((this.x1)).toString()+"px";
            this.element.style.top=((this.y1)).toString()+"px";
            this.needsDomRefresh = false;
        }
    }
    delete(){
        this.element.parentNode.removeChild(this.element);
    }
}


class Player {
    #xv;
    #yv;
    #cheat;

    constructor(mobile,width,height,game){
        if (mobile){
            this.joystick = new JoyStick({radius: window.innerHeight/8, x: window.innerWidth - window.innerHeight/8, y: window.innerHeight * 7/8, inner_radius: window.innerHeight/8 - 10})
        }
        this.width=width
        this.height=height
        this.game=game
        this.element=document.createElement("div");
        document.getElementById("game-main").appendChild(this.element);
        this.element.style.width=(width-1).toString()+"px";
        this.element.style.height=(height-1).toString()+"px";
        this.element.style.top=(window.innerHeight/2 - height/2).toString()+"px";
        this.element.style.left=(window.innerWidth/2 - width/2).toString()+"px";
        this.element.id="player";
        this.#xv=0;
        this.#yv=0;
        this.rightpressed=false;
        this.leftpressed=false;
        this.onground=true;
        this.score=0;
        var rect=this.element.getBoundingClientRect();
        this.x1 = rect.left;
        this.y1 = rect.top;
        this.x2 = rect.right;
        this.y2 = rect.bottom;
        this.jumpThroughing = false;
        // Developer mode stuff
        this.lock = "ghc1";
        this.checkPointNum = 0;
        this.#cheat = {
            active: false,
            devView: false,
            phaser: 0, // 0 = nothing, 1 = waiting for collision to phase through, 2 = phasing through
            invincible: false,
            collidesWithLava: false,
            flying: false
        }
        this.gravity = 1;
        this.touchingBlock = false;
        this.touchingX = false;
        this.touchingY = false;
        this.slipping = false;
        this.stuck = false;
    }
    delete(){
        this.element.parentNode.removeChild(this.element);
    }
    onkeyup(event){
        if (event.key == this.lock[this.checkPointNum]){
            this.checkPointNum ++;
            if (this.checkPointNum == this.lock.length){
                this.#cheat.active = true;
                alert("All cheats unlocked!");
            }
        }
        else{
            this.checkPointNum = 0;
        }
        if (event.key == "a" || event.key == "ArrowLeft"){
            this.leftpressed=false;
        }
        else if (event.key == "d" || event.key == "ArrowRight"){
            this.rightpressed=false;
        }
        if (this.#cheat.active){
            switch (event.key){
                case "r":
                    this.#cheat.devView = !this.#cheat.devView;
                    if (this.#cheat.devView){
                        document.getElementById("game-main").classList.add("revalio");
                    }
                    else{
                        document.getElementById("game-main").classList.remove("revalio");
                    }
                    break;
                case "i":
                    this.#cheat.invincible = !this.#cheat.invincible;
                    break;
                case "g":
                    this.gravity *= -1;
                    break;
                case "s":
                    this.#cheat.phaser = 1;
                    break;
                case "j":
                    this.#yv = -5 * this.gravity;
                    break;
                case "f":
                    this.#cheat.flying = !this.#cheat.flying;
                    break;
                case ".":
                    this.#xv *= 10;
                    break;
                case "a":
                    this.game.arbitraryRestructure();
                    break;
            }
        }
        if (event.key === "p"){
            alert("Paused. Click out of this alert box when you are ready to begin again.");
        }
    }
    onkeydown(event){
        console.log(event.key);
        if (event.key == "w" || event.key == "ArrowUp"){
            this.Jump();
        }
        else if (event.key == "ArrowDown" && this.#cheat.flying){
            this.#yv = 20 * this.gravity;
        }
        else if (event.key == "a" || event.key == "ArrowLeft"){
            this.leftpressed=true;
        }
        else if (event.key == "d" || event.key == "ArrowRight"){
            this.rightpressed=true;
        }
        if (event.key == "ArrowDown" || event.key == "s"){
            this.DropThrough();
        }
    }
    run(){
        if (this.leftpressed || (this.joystick && this.joystick.left)){
            this.Left();
        }
        if (this.rightpressed || (this.joystick && this.joystick.right)){
            this.Right();
        }
        if (this.joystick && this.joystick.up && this.onground){
            this.#yv = -20 * this.gravity;
            this.onground = false;
        }
        this.game.move(0,this.#yv);
        colis=this.game.checkCollision();
        if (colis["end"] > 0){
            this.game.win = true;
        }
        if (colis["tencoin"] > 0){
            this.score+=colis["tencoin"]*10;
            this.refreshscore();
        }
        if (colis["jumpthrough"] > 0 && colis["solid"] == 0){
            if (this.#yv < 0){
                this.jumpThroughing = true;
            }
        }
        else if (this.#yv >= 0){
            this.jumpThroughing = false;
        }
        if (colis["fiftycoin"] > 0){
            this.score+=colis["fiftycoin"]*50;
            this.refreshscore();
        }
        if ((colis["pedanticsolid"] > 0 || (colis["killu"] > 0 && this.#cheat.invincible)) && !this.jumpThroughing){
            if (this.#cheat.phaser == 1){
                this.#cheat.phaser = 2;
            }
            else if (this.#cheat.phaser != 2){
                while (this.game.checkCollision()["pedanticsolid"]/* + colisifiaction["jumpthrough"]*/ > 0){
                    this.game.move(0,this.#yv/Math.abs(this.#yv) * -1);
                }
                if (this.#yv*this.gravity > 0){
                    this.onground=true;
                }
                this.#yv=0;
                if (colis["ice"] > 0){
                    this.slipping = true;
                }
                else{
                    this.slipping = false;
                }
                if (colis["tar"] > 0){
                    this.stuck = true;
                }
                else {
                    this.stuck = false;
                }
            }
            this.touchingBlock = true;
            this.touchingY = true;
        }
        else if (this.#cheat.phaser == 2){
            this.#cheat.phaser=0;
        }
        else{
            this.touchingBlock = false;
            this.touchingY = false;
            this.slipping = false;
        }
        this.game.move(this.#xv,0);
        var colis=this.game.checkCollision();
        if (colis["win"] > 0){
            this.game.win = true;
        }
        if (colis["tencoin"] > 0){
            this.score+=colis["tencoin"]*10;
            this.refreshscore();

        }
        if (colis["killu"] > 0 && !this.#cheat.invincible){
            this.end();
        }
        if (colis["fiftycoin"] > 0){
            this.score+=colis["fiftycoin"]*50;
            this.refreshscore();
        }
        if (colis["solid"] > 0/* && !this.jumpThroughing*/){
            if (this.#cheat.phaser == 1){
                this.#cheat.phaser = 2;
            }
            else if (this.#cheat.phaser == 2){
                // Nothing!
            }
            else{
                while (this.game.checkCollision()["solid"] > 0){
                    this.game.move(this.#xv/Math.abs(this.#xv) * -1, 0);
                }
                this.#xv=0;
            }
            this.touchingBlock = true;
            this.touchingX = true;
        }
        else if (this.#cheat.phaser == 2){
            this.#cheat.phaser=0;
        }
        else {
            this.touchingX = false;
        }
        this.#xv*=this.slipping ? 0.97 : (this.stuck ? 0.4 : 0.8);
        if (this.#cheat.flying){
            this.#yv *= 0.8
        }
        else{
            this.#yv += this.gravity;
        }
        this.wentLeft = false;
        this.wentRight = false;
    }
    end(){
        window.alert(this.score);
        this.game.die = true;
    }
    refreshscore(){
        this.element.innerText=this.score.toString();
    }
    Jump(){
        if (this.onground || this.#cheat.flying){
            this.#yv=-20 * this.gravity;
            this.onground=false;
        }
    }
    Left(){
        if (!this.wentLeft){
            this.#xv+=2
            this.wentLeft = true;
        }
    }
    Right(){
        if (!this.wentRight){
            this.#xv-=2
            this.wentRight = true;
        }
    }
    DropThrough(){
        this.jumpThroughing = true;
    }
}


class RobotPlayer extends Player {
    constructor(mobile,width,height,game){
        super(mobile, width, height, game);
        this.RobotInit();
        this.oldScore = 0;
    }
    onkeyup(event){
        console.log("Right now, the player is a robot and will not respond to any keypresses. Please change your game constructor at the start of the code.");
    }
    onkeydown(event){

    }
    run(){
        super.run();
        this.RobotRun();
    }
    LookForLava(){
        var ret = [];
        this.game.bricks.forEach((item, i) => {
            if (this.x1 - 100 < item.x2 &&
                this.x2 + 100 > item.x1 &&
                this.y1 - 100 < item.y2 &&
                this.y2 + 100 > item.y1 &&
                item.type == "killu"    &&
                !item.element.classList.contains("enemy")){
                    ret.push([item.x1 - this.x1, item.y1 - this.y1, item.x2 - this.x1, item.y2 - this.y1]);
                }
        });
        return ret;
    }
    LookForEnemies(){
        var ret = [];
        this.game.enemies.forEach((thing, i) => {
            var item = thing[0];
            if (this.x1 - 100 < item.x2 &&
                this.x2 + 100 > item.x1 &&
                this.y1 - 100 < item.y2 &&
                this.y2 + 100 > item.y1 &&
                item.type == "killu"    &&
                item.element.classList.contains("enemy")){
                    ret.push([item.x1 - this.x1, item.y1 - this.y1, item.x2 - this.x1, item.y2 - this.y1, thing[1]]);
                }
        });
        return ret;
    }
    LookForBlocks(){
        var ret = [];
        this.game.enemies.forEach((thing, i) => {
            var item = thing[0];
            if (this.x1 - 100 < item.x2 &&
                this.x2 + 100 > item.x1 &&
                this.y1 - 100 < item.y2 &&
                this.y2 + 100 > item.y1 &&
                item.type == "solid"){
                    ret.push([item.x1 - this.x1, item.y1 - this.y1, item.x2 - this.x1, item.y2 - this.y1, thing[1]]);
                }
        });
        return ret;
    }
    // These functions below have to be overridden.
    RobotInit(){

    }
    RobotRun(){
        //this.#xv -= 1;
    }
    cheat(){
        alert("That is cheating and against the rules. You are disqualified.");
        this.game.die = true;
    }
    set xv(newVal){
        this.cheat();
    }
    /*set score(newVal){
        this.cheat();
    }*/
    set yv(newVal){
        this.cheat();
    }
    get gotCoin(){
        if (this.score > this.oldScore){
            this.oldScore = this.score;
            return true;
        }
        return false;
    }
}


class FortressRobot extends RobotPlayer{
    RobotInit(){
        this.ticker = 0;
    }
    RobotRun(){
        /*this.Right();
        if (this.touchingX){
            this.Jump();
        }
        alert(this.GetX());*/
        if (this.touchingBlock){
            this.Right();
        }
        if (this.touchingX){
            this.Jump();
        }
        var lavas = this.LookForLava();
        var didLava = false;
        if (lavas.length == 0){
            var enemies = this.LookForEnemies();
            enemies.forEach((item, i) => {
                if (item[4] > 0){
                    this.Left();
                }
                else {
                    if (!(this.game.x < -1900 && this.game.x > -2250)){
                        this.Right();
                    }
                    else {
                        alert("Silence!");
                        this.Left();
                    }
                    this.Jump();
                }
            });
        }
        lavas.forEach((item, i) => {
            if (item[2] > -5 && item[0] < 80){ // It's less than <n> pixels away
                this.Right();
                if (!(this.game.x < -2200 && this.game.x > -2250)){
                    this.Jump();
                }
                else{
                    this.Left();
                }
                didLava = true;
            }
        });
    }
}


class TrainingRobot extends RobotPlayer {
    RobotInit(){
        this.ticklies = 0;
    }
    RobotRun(){
        /*this.Right();
        if (this.touchingX){
            this.Jump();
        }
        alert(this.GetX());*/
        if (this.touchingBlock){
            this.Right();
        }
        if (this.touchingX){
            this.Jump();
        }
        var lavas = this.LookForLava();
        var didLava = false;
        lavas.forEach((item, i) => {
            if (item[2] > -5 && item[2] < 80){ // It's less than <n> pixels away
                this.Right();
                this.Jump();
                didLava = true;
            }
        });
        var enemies = this.LookForEnemies();
        enemies.forEach((item, i) => {
            if (item[4] > 0){
                this.Left();
            }
            else {
                this.Right();
                this.Jump();
            }
        });
        if (!this.touchingBlock && this.game.x > -2700 && this.game.x < -100){
            if (this.ticklies < 40){
                this.ticklies ++;
            }
            else {
                this.Jump(); // Take the airjump
                this.Right();

            }
        }
    }
}


class TinymazeRobot extends RobotPlayer{
    RobotInit(){
        this.state = 0;
        this.ticker = 0;
    }
    RobotRun(){
        /*this.Right();
        if (this.touchingX){
            this.Jump();
        }
        alert(this.GetX());*/
        if (this.state == 0 || this.state == 1){
            var lavas = this.LookForEnemies();
            if (this.touchingY){
                if (lavas.length == 0){
                    if (this.game.x > -825){
                        this.Right();
                    }
                    else{
                        if (this.game.x < -825){
                            this.Left();
                        }
                        this.Jump();
                        this.state = 1;
                    }
                }
                else if (lavas[0][0] > 0){ // It can only encounter one lava at a time on this level
                    this.Left();
                }
            }
            if (this.touchingX){
                this.Jump();
                this.Right();
            }
            if (this.state == 1){
                if (this.game.y > -150){
                    this.state = 2;
                }
            }
        }
        else if (this.state == 2){
            var enemies = this.LookForEnemies();
            enemies.forEach((item, i) => {
                if (item[0] > -65){ // 50 (player width) + 15 (margin)
                    this.Jump();
                }
            });
            //this.Right();
            //if (this.game.x < -1500){
                this.state = 3;
            //}
        }
        else if (this.state == 3){
            if (this.game.x < -925){
                this.Left();
            }
            if (this.game.x > -925){
                this.Right();
                if (this.touchingY){
                    this.state = 3.2;
                }
            }
        }
        else if (this.state == 3.2){
            this.Jump();
            if (this.game.x < -775){
                this.Left();
            }
            if (this.game.x > -775){
                this.Right();
                if (this.touchingY){
                    this.state = 3.3;
                }
            }
        }
        else if (this.state == 3.3){
            this.ticker ++;
            if (this.touchingY){
                this.state = 3.5;
                this.ticker = 0;
                this.Jump();
            }
        }
        else if (this.state == 3.5){
            if (this.game.x < -1525){
                this.Left();
                if (this.touchingY){
                    this.state = 5;
                }
            }
            if (this.game.x > -1525){
                this.Right();
            }
        }
        else if (this.state == 4){
            this.ticker ++;
            if (this.ticker > 10){
                this.state = 5;
            }
        }
        else if (this.state == 5){
            if (this.game.x < -1575){
                this.Left();
                this.state = 6;
                console.log(this.gotCoin);
            }
            if (this.game.x > -1575){
                this.Right();
            }
        }
        else if (this.state == 6){
            this.Jump();
            this.Left();
            if (this.gotCoin){
                this.state = 7;
                this.ticker = 0;
            }
        }
        else if (this.state == 7){
            if (this.touchingY){
                this.state = 8;
            }
        }
        else if (this.state == 8){
            this.ticker ++;
            if (this.ticker > 30){
                this.state = 9;
            }
        }
        else if (this.state == 9){
            this.Right();
            this.Jump();
        }
    }
}


class PrivateTestRobot extends RobotPlayer{
    pidTo(pos){
        if (this.game.x > pos){
            this.Right();
        }
        else{
            this.Left();
        }
        if (this.game.x > pos - 2 && this.game.x < pos + 2){
            return true;
        }
        return false;
    }
    RobotInit(){
        this.phase = 0;
        this.ticker = 0;
    }
    RobotRun(){
        if (this.phase == 0){
            if (this.pidTo(-200)){ // pidTo uses the limited functions I made available (this is for a virtual robotics competition I'm hosting) to get as close to a certain point as possible.
                this.phase = 1;
            }
        }
        else if (this.phase == 1){
            this.Jump();
            this.phase = 2;
        }
        else if (this.phase == 2){
            if (this.pidTo(-430) && this.touchingY){ // Each block is 50, so this goes 4 blocks forwards. All the coordinates are reversed.
                this.phase = 3;
            }
        }
        else if (this.phase == 3){
            this.ticker ++;
            this.Jump();
            if (this.ticker > 10){
                this.phase = 4;
                this.ticker = 0;
            }
        }
        else if (this.phase == 4){
            if (this.pidTo(-700)){
                this.phase = 5;
            }
        }
        else if (this.phase == 5){
            this.Jump();
            this.phase = 6;
        }
        else if (this.phase == 6){
            this.Right();
            if (this.touchingY){
                this.phase = 7;
            }
        }
        else if (this.phase == 7){
            this.Right();
            if (!this.touchingY){
                this.phase = 8;
                console.log(this.gotCoin);
            }
        }
        else if (this.phase == 8){
            if (this.touchingY){
                this.phase = 8.5;
            }
        }
        else if (this.phase == 8.5){
            this.Jump();
            this.Left();
            if (this.touchingX){
                this.phase = 9;
            }
        }
        else if (this.phase == 9){
            this.Right();
            if (this.touchingY){
                this.phase = 10;
            }
        }
        else if (this.phase == 10){
            if (!this.gotCoin){
                this.phase = 8;
                //this.Right();
            }
            else{
                this.phase = 11;
            }
        }
        else if (this.phase == 11){
            this.Right();
        }
    }
}


class Game{
    constructor(mobile, playerClass = Player, xoffset=0,yoffset=0,brickwidth=50,brickheight=50){
        this.die = false;
        this.win = false;
        this.bricks=[];
        this.minigames=[];
        this.xoffset=0;
        this.yoffset=0;
        this.brickWidth=brickwidth;
        this.brickHeight=brickheight;
        this.player=new playerClass(mobile, 49,99,this);
        this.onkeyup = (event) => {
            this.player.onkeyup(event);
        };
        this.onkeydown = (event) => {
            this.player.onkeydown(event);
        };
        window.addEventListener('keydown', this.onkeydown);
        window.addEventListener("keyup", this.onkeyup);
        this.minigame = document.getElementById("minigame");
        this.minigameTick = 0;
        this.minigamePlaying = null;
        this.enemies = [];
        this.probPassers = [];
        this.runningEnemies = true;
        this.checkPoints = [];
        this.y = 0;
        this.x = 0;
        this.scale = 1;
        this.minExtent = 6000;
    }
    arbitraryRestructure(){

    }
    _createBrick(x,y,width,height,renderclass,type,text,visibleText, probability){
        var x = new Brick(x+window.innerWidth/2+this.xoffset,y+window.innerHeight/2+this.yoffset,width,height, this.scale,renderclass,type,text,visibleText, probability);
        this.bricks.push(x);
        return x;
    }
    createBrick(x,y,horizLen, height, renderclass="regular",type="solid", probability){
        return this._createBrick(x*this.brickWidth,y*this.brickHeight,this.brickWidth * horizLen,this.brickHeight * height,renderclass,type, undefined, undefined, probability);
    }
    createHorizontal(x,y,width,renderclass="regular",type="solid"){
        this._createBrick(x*this.brickWidth,y*this.brickHeight,width*this.brickWidth,this.brickHeight,renderclass,type);
    }
    createVertical(x,y,height,renderclass="regular",type="solid"){
        this._createBrick(x*this.brickWidth,y*this.brickHeight,this.brickWidth,height*this.brickHeight,renderclass,type);
    }
    createSquare(x,y,width,height,renderclass="regular",type="solid"){
        this._createBrick(x*this.brickWidth,y*this.brickHeight,width*this.brickWidth,height*this.brickHeight,renderclass,type);
    }
    createSign(x,y,text,visibleText){
        this._createBrick(x * this.brickWidth, y * this.brickHeight, this.brickWidth, this.brickHeight, "sign", "notsolid", text,visibleText);
    }
    createMinigameBlock(x, y, minigameType){
        this._createBrick(x * this.brickWidth, y * this.brickWidth, this.brickWidth, this.brickHeight, "minigame", "minigame", undefined, undefined, minigameType);
    }
    createByLetter(x, y, width, height, letter){
        switch (letter) {
            case "r": // Regular, old - toy - story block.
                this.createBrick(x, y, width, height);
                break;
            case "c": // Coins
                this.createBrick(x, y, width, height, "tencoin", "tencoin")
                break;
            case "l": // Lava
                this.createBrick(x, y, width, height, "lava", "killu");
                break;
            case "C": // Big Coins
                this.createBrick(x, y, width, height, "fiftycoin", "fiftycoin");
                break;
            case "f":
                this.createBrick(x, y, width, height, "lava", "notsolid");
                break;
            case "F":
                this.createBrick(x, y, width, height, "regular", "notsolid");
                break;
            case "i":
                this.createBrick(x, y, width, height, "invisible", "solid");
                break;
            case "I":
                this.createBrick(x, y, width, height, "invisible", "killu");
                break;
            case "G":
                this.createBrick(x, y, width, height, "lava", "solid");
                break;
            case "e":
                this.enemies.push({
                    type: "normal",
                    brick: this.createBrick(x, y, 1, 1, "lava enemy", "killu"),
                    speed: 5,
                    yv: 0
                });
                break;
            case "E":
                this.enemies.push({
                    type: "normal",
                    brick: this.createBrick(x, y, 1, 1, "lava enemy", "killu"),
                    speed: 10,
                    yv: 0
                });
                break;
            case "L":
                this.createBrick(x, y, width, height, "lava", "killu_nocol")
            case "ǝ":
                this.enemies.push({
                    type: "normal",
                    brick: this.createBrick(x, y, 1, 1, "lava enemy", "killu"),
                    speed: -5,
                    yv: 0
                });
                break;
            case "z":
                this.createBrick(x, y, width, height, "invisible", "elevator");
                break;
            case "Z":
                this.createBrick(x, y, width, height, "invisible", "bigElevator");
                break;
            case "v":
                this.createBrick(x, y, width, height, "invisible", "notsolid");
                break;
            case "p":
                this.createBrick(x, y, width, height, "regular", "solid", 0.1);
                break;
            case "P":
                this.createBrick(x, y, width, height, "regular", "solid", 0.5);
                break;
            case "d":
                this.createBrick(x, y, width, height, "invisible", "enemyFlipperRight");
                break;
            case "D":
                this.createBrick(x, y, width, height, "invisible", "enemyFlipperLeft");
                break;
            case "k":
                this.checkPoints.push([x, y]);
                break;
            case "n":
                this.createBrick(x, y, width, height, "end", "end");
                break;
            case "j":
                this.createBrick(x, y, width, height, "jumpthrough", "jumpthrough")
                break;
            case "1":
                this.enemies.push({
                    type: "normal",
                    brick: this.createBrick(x + Math.random() * (width - 1), y, 1, 1, "lava enemy", "killu"),
                    speed: -5,
                    yv: 0
                });
                break;
            case "2":
                this.createBrick(x + Math.random() * (width - 1), y, 1, 1, "lava", "killu");
                break;
            case "3":
                this.createBrick(x + Math.random() * (width - 1), y, 1, 1, "regular", "solid");
                break;
            case "S":
                this.createBrick(x, y, width, height, "ice", "ice");
                break;
            case "b":
                this.enemies.push({
                    type: "bat",
                    brick: this.createBrick(x, y, 1, 1, "lava bat", "killu"),
                    speed: -5,
                    yv: 0
                });
                break;
            case "t":
                this.createBrick(x, y, width, height, "tar", "tar");
                break;
        }
    }
    createByTileset(x,y,tileset, signs){
        var ix=x;
        var iy=y;
        var curHoriz = 0;
        var curHorizType = undefined;
        var signNum = 0;
        tileset.split("").forEach((item, i) => {
            if (item == "s"){
                this.createSign(ix, iy, signs[signNum]);
                signNum ++;
            }
            else {
                if (curHorizType == item && ["e", "E", "c", "C"].indexOf(item) == -1){
                    curHoriz ++;
                }
                else {
                    this.createByLetter(ix - curHoriz, iy, curHoriz, 1, curHorizType);
                    curHorizType = item;
                    curHoriz = 1;
                }
            }
            ix++;
            if (item == "\n"){
                ix = x;
                iy ++;
                this.minExtent = (iy + 2) * 50;
            }
        });
    }
    createHollowSquare(x,y,width,height,renderclass="regular",type="solid"){
        width-=1;
        height-=1;
        this.createHorizontal(x,y,width,renderclass,type);
        this.createVertical(x,y-height,height,renderclass,type);
        this.createHorizontal(x+1,y-height,width,renderclass,type);
        this.createVertical(x+width,y-height+1,height,renderclass,type)
    }
    move(xm,ym){
        this.bricks.forEach((item, i) => {
            item.move(xm,ym*-1);
        });
        this.x += xm;
        this.y -= ym;
        if (this.y < -this.minExtent){
            this.die = true;
        }
    }
    apply(){
        this.bricks.forEach((item, i) => {
            item.apply();
        });
    }
    checkCollision(object = this.player, holes = false, supercilious = false){ // Collisions are a pixel smaller than they should be, if "holes" = true. Supercilious makes it 2 pixels to account for tidal drag.
        var dictionary={
            "solid":0,
            "notsolid":0,
            "killu":0,
            "tencoin":0,
            "fiftycoin":0,
            "minigame":0,
            "elevator":0,
            "bigElevator":0,
            "end":0,
            "jumpthrough":0,
            "pedanticsolid":0,
            "ice": 0,
            "all":0,
            "tar":0
        };
        var passers = 0;
        this.bricks.forEach((item, i) => {
            if (item.probprob != 1){
                passers ++;
            }
            if (((item.x2 >= object.x1 &&
                item.x1 <= object.x2 &&
                item.y2 >= object.y1 &&
                item.y1 <= object.y2 && !holes && !supercilious)
                || (item.x2 > object.x1 &&
                    item.x1 < object.x2 &&
                    item.y2 > object.y1 &&
                    item.y1 < object.y2 && holes && !supercilious)
                    || (item.x2 - 1 > object.x1 &&
                        item.x1 + 1 < object.x2 &&
                        item.y2 > object.y1 &&
                        item.y1 < object.y2 && supercilious)))
            {
                if (item.probprob > Math.random()){
                    dictionary[item.type]++;
                    if (item.type=="tencoin" || item.type=="fiftycoin"){
                        item.element.parentNode.removeChild(item.element);
                        this.bricks.splice(i,1);
                    }
                    if (item.type=="minigame"){
                        dictionary["solid"]++;
                        this.playMinigame(item.element.getAttribute("data-minigame"));
                    }
                    if (!(item.type=="elevator" || (item.type == "bigElevator") || item.type == "enemyFlipper")){
                        dictionary["all"]++;
                    }
                    if (item.type == "jumpthrough"){
                        dictionary.pedanticsolid ++;
                    }
                    if (item.type == "solid"){
                        dictionary.pedanticsolid ++;
                    }
                    if (item.type == "ice"){
                        dictionary.solid ++;
                        dictionary.pedanticsolid ++;
                    }
                    if (item.type == "tar"){
                        dictionary.solid ++;
                        dictionary.pedanticsolid ++;
                    }
                }
                else if (!this.probPassers.includes(object)){
                    this.probPassers.push(object);
                }
            }
        });
        if (passers == 0 && this.probPassers.includes(object)){
            this.probPassers = this.probPassers.filter(function(value, index, arr){
                return value == object;
            });
        }
        return dictionary;
    }
    horizontalBetween(object, object2 = this.player){
        var isBetween = false;
        this.bricks.forEach((item, i) => {
            if (item != object && item != object2){
                var val1 = item.y1 - object.y1;
                var val2 = item.y1 - object2.y1;
                if (val1 * val2 < 0){
                    if ((item.x2 > object.x1 && item.x1 < object.x2) ||
                        (item.x2 > object2.x1 && item.x1 < object2.x2)){
                        isBetween = true;
                    }
                }
            }
        });
        return isBetween;
    }

    verticalBetween(object, object2 = this.player){
        var isBetween = false;
        this.bricks.forEach((item, i) => {
            if (item != object && item != object2){
                var val1 = item.x1 - object.x1;
                var val2 = item.x1 - object2.x1;
                if (val1 * val2 < 0){
                    if ((item.y2 > object.y1 && item.y1 < object.y2) ||
                        (item.y2 > object2.y1 && item.y1 < object2.y2)){
                        isBetween = true;
                    }
                }
            }
        });
        return isBetween;
    }

    run(){
        if (this.die || this.win){
            if (this.win){
                document.getElementById("gamewin").style.display="block";
                document.getElementById("gamewin").innerText = "You beat the level! Your score: " + this.player.score;
                window.levelsBeaten ++;
                if (window.levelsBeaten == window.phases[window.phase - 1].length){
                    window.phase ++;
                    loadPhase(window.phase);
                    window.levelsBeaten = 0;
                }
                var variab = document.getElementById(document.querySelector("#levelselect > select").value);
                variab.parentNode.removeChild(variab);
            }
            if (this.die){
                document.getElementById("gameover").style.display="block";
            }
            window.removeEventListener('keydown', this.onkeydown);
            window.removeEventListener("keyup", this.onkeyup);
            this.bricks.forEach((item, i) => {
                item.delete();
                item = null;
            });
            this.enemies.forEach((item, i) => {
                item = null;
            });
            this.player.delete();
            this.bricks = null;
            this.enemies = null;
            this.player = null;
            setTimeout(() => {
                document.getElementById("gameover").style.display="none";
                document.getElementById("gamewin").style.display="none";
                document.getElementById("menu").style.display="";
            }, 2000);
            return true;
        }
        if (this.minigamePlaying){
            var city = this.minigames[this.minigamePlaying](this.minigame, this.minigameTick); // Should return 0 or any other falsey number if no effect, 1 if the player wins, 2 if the player loses.
            if (city == 1){
                 this.minigame.style.display = "none";
                 this.minigamePlaying = false;
            }
            else if (city == 2){
                minigameActiveBlock = this.minigameActiveBlock.element;
                this.minigameActiveBlock.parentNode.removeChild(this.minigameActiveBlock);
                this.bricks = this.bricks.filter(item => item !== this.minigameActiveBlock);
            }
            this.minigameTick ++;
        }
        else{
            this.player.run();
            this.apply();
        }
        if (this.runningEnemies){
            this.enemies.forEach((item, i) => {
                if (item.type == "normal"){
                    item.yv ++;
                    item.brick.move(0, item.yv);
                    if (this.checkCollision(item.brick, true, true)["all"] > 1){
                        while (this.checkCollision(item.brick, true, true)["all"] > 1){
                            item.brick.move(0, -Math.abs(item.yv)/item.yv);
                        }
                        item.yv = 0;
                    }
                    for (var i = 0; i < Math.abs(item.speed); i ++){
                        item.brick.move(Math.abs(item.speed)/item.speed, 0);
                        var coll = this.checkCollision(item.brick, true);
                        if (coll["elevator"] > 0){
                            item.yv = -20;
                        }
                        if (coll["bigElevator"] > 0){
                            item.yv = -40;
                        }
                        if (coll["all"] > 1){
                            while (this.checkCollision(item.brick, true)["all"] > 1){
                                item.brick.move(-Math.abs(item.speed)/item.speed, 0);
                            }
                            item.speed *= -1;
                        }
                    }
                }
                else if (item.type == "bat"){
                    if (!(this.verticalBetween(item.brick) || this.horizontalBetween(item.brick))){
                        item.active = true;
                    }
                    if (item.active){ // It's undefined until it's true, ya know?
                        item.yv ++;
                        item.brick.move(0, item.yv);
                        if (this.checkCollision(item.brick, true, true)["all"] > 1){
                            while (this.checkCollision(item.brick, true, true)["all"] > 1){
                                item.brick.move(0, -Math.abs(item.yv)/item.yv);
                            }
                            item.yv = 0;
                            item.type = "flyer";
                            item.brick.element.classList.add("bat-active");
                        }
                        item.brick.move(0, item.yv);
                    }
                }
                else if (item.type == "flyer"){
                    if (this.player.y2 < item.brick.y1){
                        item.yv --;
                    }
                    else if (this.player.y1 > item.brick.y2){
                        item.yv ++;
                    }
                    if (this.player.x2 < item.brick.x1){
                        item.speed --;
                    }
                    else if (this.player.x1 > item.brick.x2){
                        item.speed ++;
                    }
                    item.speed *= 0.9;
                    item.brick.move(0, item.yv);
                    if (this.checkCollision(item.brick, true, true)["all"] > 1){
                        while (this.checkCollision(item.brick, true, true)["all"] > 1){
                            item.brick.move(0, -Math.abs(item.yv)/item.yv);
                        }
                        item.yv = 0;
                    }
                    for (var i = 0; i < Math.abs(item.speed); i ++){
                        item.brick.move(Math.abs(item.speed)/item.speed, 0);
                        var coll = this.checkCollision(item.brick, true);
                        if (coll["elevator"] > 0){
                            item.yv = -20;
                        }
                        if (coll["bigElevator"] > 0){
                            item.yv = -40;
                        }
                        if (coll["all"] > 1){
                            while (this.checkCollision(item.brick, true)["all"] > 1){
                                item.brick.move(-Math.abs(item.speed)/item.speed, 0);
                            }
                            item.speed *= -1;
                        }
                    }
                }
            });
        }
    }

    registerMinigame(name, play){ // Register minigame functions. All should take the element to draw on (dynamic!), play should also take the tick value.
        this.minigames[name] = play;
    }

    playMinigame(name){
        this.minigame.style.display = "block";
        this.minigamePlaying = name;
        this.minigameTick = 0;
    }
    toggleEnemies(){
        this.runningEnemies = !this.runningEnemies;
    }
}

var g=null;
document.getElementById("playbutton").addEventListener("click",function(){
    g=new Game(document.querySelector("#mobileOrNot > input").checked);//, PrivateTestRobot);//, TrainingRobot);
    window.levelMakerContext = getLevelmakerContext(g);

    // Drawing here!
    window.phases[window.phase - 1].forEach((item, i) => {
        if (item.id == document.querySelector("#levelselect > select").value){
            item.func();
        }
    });

    document.getElementById("menu").style.display="none";
    Array.from(document.getElementsByClassName("tencoin")).forEach((item, i) => {
        item.innerHTML="<p class='coin_text'>10</p>";
    });
    Array.from(document.getElementsByClassName("fiftycoin")).forEach((item, i) => {
        item.innerHTML="<p class='coin_text big'>50</p>";
    });

    c=setInterval(function(){
        if (g.run()){
            clearInterval(c);
        }
    }, 20);
});

loadPhase(window.phase);
