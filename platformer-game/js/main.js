var lvl1_nerf=`
 c
lhHhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhH r r
 r          rC                        r r
 r          r                         r r
 r          rrrrr rrrrrrrrrrrrrrrrrrrrr r
lr          r                         r r
 r          r                         r r
 r          r    r rr  rrrrrrrrr  rrrrr r
 r          r    r r               cr r r
lr          rrrr r r                r r r
 r               r r rrrrrrrrrrrrrr r r r
 r               r r                  r r
 rrrrrrrrrrrr    r r                  r r
lrCc        r  rrr rrrrrrrrrrrrrrrrrr r r
 r             r                      r r
 r             rC                    cr r
 rrrrrrrrrrrrrrr                      r r
lrcccccccccccccr                      r r
  cccccccccccccr                      r r
  cccccccccccccr                      r r
 r rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr r
 r                                      r
 r                                      r
 r                                      r
 rr            l           l     l      r
 rrl rl rl rl rl rl   rrl rl rl rl rll rr

 llllllllllllllllllllllllllllllllllllllll

 CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`
var lvl1=
`                                zzzzzzzz

 v                                      v
 r    e    e     e     e     e          vZ
 rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr rr
 r                                    r r
 r                                    r  r
 r                                    r   r
 r                                    r    r
 r   rrrrrrrrrrrr rrrrrrrrrrrrrrrrrrrrr     r
 r          r     v                   r r    r
 r          rvvvv                             r
 r          r    rvrrvrrrrrrrrrrrvrrrrrvrr     r
 r          r    r r               cr r r r     r
 r          rrrr r r                r r r  r     r
 r               r r rrrrrrrrrrrrrrrr r r   l    lr
 rrrrrrrr        r r                  r r    r   llr
 r      rrrr     r r                  r r         llr
 rCc        rrrrr   rrrrrrrrrrrrrrrrr r r        l  lr
 r                                    r r       r
 r      z    e v z                    r r      l
 rrrrrrrrrrrrrrr z     z z z z z z  r r r     r
 rcccccccccccccr z                    r r    l
  cccccccccccccr z    z z z z z z z   r r   r
  C   C   C   Cr  z                  lr r  r
 r rrrrrrrrrrrrrllrrrrrrrrrrrrrrrrrrrrr r
 r                                      r
 r                                       r
 rzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz    r
 rr            l           l     l                         l
 rrl rl rl rl rl rl   rrl rl rl rl rll rrrrrrrrrrrrlllllllll
v
v llllIIIlllIIIllllIIIlllllIIIlllIIIlIIIll
v
vCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCn
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`

var lvl2 = `
l
l
l
f
f
f
f
l
l
l     s
rrrrrrrrr          r       r       r       r       r       r
r
r
r                                                                  r
r
r
r                                                                        r
r
r       e
lllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllll llllllllllllllr            l
                                                                    v                          l
                                                                    v                          l
                     c    c                                         v                  c       l
           cll      c  c  l  c                                      v                  c       l
    c  c l    l        l     l  c       zlz lz  z  zl z  zllllcz  zl                  c        l
    l   l      c  lz   l     l  c        l  lc   c     c  c c   c   c l  l  l  l  l  l c       l
 n               l  z   ccc     llllzclzc  c     lz    lz       lz lz  c  c  c  c  c r cǝ      l
 r lrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`
var ethan_lvl=
`


                                   rrrr   rrrrrrrrrrrrrrrrrrrrrrrrr l
                                   r                   r            l
                                   r                   r            l
                                   r                   r            l
                                   r                   r            l
                                   r                   r            l
                                   ree                 r            l
                                   r rrrrrrrrrrrrrrrrrrr
                                   r
                                   rrrrrrrrrrrrrrrrrrrrrrrr    frrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr         rrrrffrrr c


                                                   rrrrrrrrr


l
l                                                rrrr
l                                                        rrrrr
l          l
l          l
l          l                                                     r
r   e        ǝ ǝ ǝ ǝ ǝ ǝ ǝ    zrzzcccc                     rrrrrrr
rrrrrrr  rrrrrrrrrrrrrrrrr z  rllllllr                    r
f                           zrllllllll                  r
f                          zr             r       rrrrrrrrr
r                         zr
r                        zr             l
r                       zrcccccccccc rrrr
r  r                   zrccccccccccccr
rrrrrrrrrrrrrrrrrrrrrrrrrr rrrrrrrrrrr       IIIIIIIIIIIIII  I
I                                                            I
I                                                        rIIII
I                                                        r             iiiiiiiiiiii
I                                                        r
I                           lllllllllllFFFFFFFFFrrrrrrrrrr
I        iiiii    rccccccc r  lrr                                                     iiiiiiiiiiiii
    CCCCCCC i    rrrrrrrrrr
     iiiii ii

    i                          c                                                                    i i
                       rrr  cccrr                                                                   i i
            ---rccc r ǝǝǝǝǝ rrr
r-r    eee    rrrrrrrrrrrrrr       r                                                                   CCCCCCC
rrrrrrrrrrrrrrrr
rcccccccccccccc                r   ee   r                                                            rrrrrrrrrrrrrrrrrr
rcccccccccccccc  l              rrrrrrrr
r CCCCCCCCCCCCCCC            r
r          e        r  r rrr
rrrrrrrrrrrrrrrrrrrr






                                                                                                                        iiiiiiiiiiiiiiiiiiiiir





                                                                                                                                             iiiiiiii


                                                         CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
                                                        rrrrrrrrrrrrrrrrrrlllllllrlllllrrrrr         CCCCCCCCCCCCCCCCCC
iiiiiiiiiiiiii                              r       r                                                rrrrrrrrrrrrrrrrrr
                 cccccccccc       r
                 rrrrrrrrrr                                                                                                                         iiiiii



                                                                                                                                                           iiiir



                                                                                                                            i                    ee         i
                                                                                                                            iiiiiiiiiiiiiiiiiiiiiiiiifiiiiiii
                                                                                                                            i                              i
                                                                                                                            i CCCCCCCCCCCCCCCCCCCCCCCCCC   iC
                                                                                                                            iiiiiiiiiiiiiiiiiiiiiiiiiiiiiIIiii








                                                                                            r                         r
                                                                                            rrrrrrffrrrrrrrrrrrrrrrrrrr
                                                                                            r                         r


                                                                                            rCCCCCCCCCCCCCCCCCCCCCCCCCr
                                                                                            rrrrrrrrrrrrrrrrrrrrrrrrr r
`

var the_plains = `
                                                                      l
                                                                      l
                                                                      l
                                                                      l
         l                                                            l
         l                                                            l
         l                                                   llllll   l
r        l                                           cl    rl      r  l
r                                                    rl    r       r  l  C
r                                                     l    r     r r  l lrrrr
r                cl                                  cl    r     r r        r
r        c       rl       l                          rl   rr     r r        r
r        l        l      l l                          l    r     r rrrrrrrr r
r        r        l     lCcCl                         l    r    rr                                                    r
r        r        l  c  lC Cl k  c   c   c   c      k l c  r     r              k        c        c        ckl   l k  lCl  n
rrrrrrrrrrrrrrrrrrrrrrrrr   rrr rrlllrlllrlllrrrr rrrrrrrrrr   crrrrrrrrrrrrrrrrrllllllllrllllllllrllllllllrrrrrrrrrrrrrrrrr
                        r       r               l l            r
                        r       r               l Cl          l
                        r       r               l  Cl         l
                        rrrrrrrrr               l   Cl      cl
                                                l           r
                                                l          l
                                                l          l
                                                l        cl
                                                l        r
                                                 l      l
                                                  lccccCl
                                                   lrrrl
`

var actual_maze = `
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrl
r                                       r
r                                       rr
r              rrr rrrrrrrrrrrrrrrr rrrrr
r                r rCC                  r
r    s           r rCC                  rr
rrrrrrrrrrrrrrrr r rrlrrlrrlrrrrrrrrrrr r
               r r                    r r
               r rCcccccccccccccccccccr r
               r rrrrrrrrrrrrrrrrrrrllr rrr
               r                      r   r
       l       r                      r   r
       lr      r                      rr  rr  cccc cccc cccc cccc cccc
       l       r                      r   rrCv e     e           e    v
       l       r C    c     c    c   cr   rrrrrrrrrrrrrrrrrrrrrrrrrrrr
       lr      rlrllllrlllllrllllrlllrr r v                          r
       l                                r v                          r
       l                                rCv   e                      r
s      l                                rrrrrrrr                     V  r
l rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr       rz     l      ele    V r
l                                                rrrrrrrrrrrrrrrrrrrrrrr
l                                         rlr                         r
rrrrrrrrrrrrrrr rrrrrrrrrrrrrrrrrrrrrrrrrrlClr c c c                 sr
r                                             rrrrrrrrrrrrrrrrrrrrrrrrr
rc c c c c c c c c c C c C c C c C c C c C c
rrrrrrrrrrrrrrrrrrrrrrrr rrrrrrrrrrrrrrrrrrrrrr
r                                             r r rrrrrrrrrrrrrrrrrrrrrrrr
r                       C                     r r                        r
r rrrrrrrrrrrrrrrrrrrrrr rrrrrrrrrrrrrrrrrrrr r r          rrrrr         r
r                                               rrr rrrrrr r           r r
r                                           c   r        r r     rrrrrrr r
rrrrrrrrrrrrrrrrrrrrrrrlllrrrrrrrrrrrrrrrrrrrrrrrc      lr   rrrr        r
                                            r    rrrrrr rr   r           r
                                            r         r rrrrrc    rrrrrrrr
                                            rCCCCCCCCCCCr      r         r
                                            rCCCCCCCCCCCr       r        r
                                            r           l       rrrrrrrr r
                                            r           lCCCCCCCCCCCCCCr r
                                            rrrrrrrrrrrrrrrrrr         r r
                                                        r              r r
                                                        r     c c c c cr r
                                                        r    rrrrrrrrrrr rrr
                                                        r              rCCCl
                                                        r         cccccrCCnl
                                                        r              rrrrr
                                                        r              r
                                                        r c c c c c c cr
                                                        rrrrrrrrrrrrrrrr
`

var training = `
r           s
rrrrrrrrrrrrrllrrrr                                r
                    ccccccccs                      r
                    rrrrrrrrr                      r
                                                   r
                                r    e r   c      srccc
                                rrrrrrrrrrrr      rrjjjr
                                                       r
                                                       r
                                                       r
                                                 rrrrrrr
                                                               s
                                                             rrrSSSSS       s
                                                                         rrrrrrrrrr
                                                                        rr    b   V
                                                                        V         V
                                                                        V         V
                                                                        Vc       cV
                                                                      rrrrrrrrrrrrrrr
                                                                                            s   uuu
                                                                                          rrrrrrrrr
                                                                                         rr b   b rr
                                                                                         V         V
                                                                                         V         V
                                                                                         V         V
                                                                                       rrrrVVVVVVVrrrr
                                                                                         r         r          s
                                                                                         r  ccCcc  r   r @  l r
                                                                                         rrrrrrrrrrr   rrrrrrrr
                                                                                                                   s #
                                                                                                                 rrrrrrr
                                                                                                                           s
                                                                                                                         rrrrrrr

                                                                                                                                   k  s  n
                                                                                                                                  rrrrrrrrr
`

var tinymaze = `
r                c
r                r
r                r              c
r                r     e        r
r                rvrrrrrrrrrvrrrr
r    c                     r                     n
r    r       e           vcr  c    lll      rrrrr
rrrrrrrrrrrrrrvrrrrrrrrrrr rrrrrrrrrrr   e  r
                                     rrrrrrrr
        c       r          e  vcr
        rrrrrrrrrrrrrrrrrrrrrrr r
                              rlr
`

var fortress = `
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
r                                                  r
r                                                  r
r                                                  r
r           c         c         c        c         r
r    r      l        ele        l       ele     l nr
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`

var office = `
       llllllllrrrrrrrrnr
       r               Cr
       r               Cr
       r               Cr
       r       l       rr
       r v         e   rr
       rjrrrrrrrrrrrrrrrr
       r  E             r
       r         e      r
       rvvvvvvvvvvvvvvvvr
       rr               r
       rr l    l    l   r
       rrrrrrrrrrrrrrrrjr
       r V              r
       r V              r
       r V              r
       r V             rr
       r V       g     rr
       rjrrrrrrrrrrrrrrrr
       rC               r
       rC               r
       r                r
       rr  E            r
       rrvvlvvvvlvvvvlvvr
       rrrrrrrrrrrrrrrrjr
       r                r
       r                r
       r               Cr
       r               rr
       r  e   e   e    rr
       rjrrrrrrrrrrrrrrrr
       r                r
       r                r
       rc               r
       rr               r
       rr    e     e    r
       rrrrrrrrrrrrrrrrjr
       r                r
       r                r
       r               cr
                       rr
    s  v      e        rr
rrrrrrrrrrrrrrrrrrrrrrrrr
`

var platformer_robotics_competition = `
r            l
r
r            c               22C 22  22  llc                       CCC
r                            rrrrrrrrrrrrrr  333   333   333   333 rrr
r                          rrr
r
r     c      l  22222  c
rrrrrrrrlllrrrrrrrrrrrrrrrr
                         r
                         r
                         r
                         r
                         r
                         r
                         rc
                         rc
                         rllrrrrrrrrrr

`;

var new_features_wonderland = `
r           r               r
r           r               r
r           r               r
r           r               r
r           r               r
r           rrjjrrSSSSS SSSSS
r                r         v
rc      c   u   cr         vb
rSSSSSSSSSSrrrrrrr         v
            b              v
                           v
                   rrrrrrttt             C
                   r                c    r
    rjjSSSSSrrrrrrrr                r    b
    r              v            r   r       rr
                   v
           @       v              r
rrrrrttttttttttrrrrrrrrrrrrrrrrrrrrrrrrrrrrlllll  rr
                                      r
                                      r       n
                                      rrrrrrrrrrrrrr
`;

var cave_1 = `
                                   VVV
r                                  VbV                                V             V
r                                                                     V             V
r            V B C   C   C BV     c   c                               V c        c  V
r            VrrrrrrrrrrrrrrV                                         V             V
r            V              V                                         V             V
r     s      V              V                                         V   g     g   V  cccc n
rrrrrrrrrr   V              V   rrrrrrrrr                            rrrrrrrrrrrrrrrrrrrrrrrr
         r   V              V   r       r    c                       r
         r c V      g       Vcccr       r    GG      GG      GG      r
         rrrrrrrrrrrrrrrrrrrrrrrr       r    GG      GG      GG      r
                                        r    GG      GG  c   GG      r
                                        r    GG      GGGGGGGGGG      r
                                        r    GG              GG      r
                                        r c  GG         c    GG      r
                                        rrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
`

var cave_2 = `
    n
r  rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
rjjr                     V           r
r  r                     V           r
r  r                     V           r
r  rkC                   V           r
rjjrrrrrrrrrVVVVVVVVVVVVVV           r
r  r   b   r             Vl   l   l  r
r  r       r             V           r
r  r       r             V  l   l    r
rjjr       rb  b     b  bV           r
r  r       r             Vl   l   l  r
r         VVV            V           r
r         VVV@           V  l   l Ck#r
rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr

`

var hunt = `


             rrrrrrrrrr              rrrJJJrrr
                b                    r       r
    rrrrrrrr                  k      r       r
                             rrr     rk     nr
             rr                      rrrJJJrrr
rrr
                          rrr
                   k
rr            rrrrrrrrrrr
           rrrr                                    k
    rrr                        rrr                rrr

                                                       r
r                                                     r
                                                     r
             rr         rr                          r
 rr   rrr                                          r
                  rrr         rrr       rrrrr
`

var test =`
    i
rrrrrrrr
`

function Easter(Y) { // Thank'y stackoverflow!
    var C = Math.floor(Y/100);
    var N = Y - 19*Math.floor(Y/19);
    var K = Math.floor((C - 17)/25);
    var I = C - Math.floor(C/4) - Math.floor((C - K)/3) + 19*N + 15;
    I = I - 30*Math.floor((I/30));
    I = I - Math.floor(I/28)*(1 - Math.floor(I/28)*Math.floor(29/(I + 1))*Math.floor((21 - N)/11));
    var J = Y + Math.floor(Y/4) + I + 2 - C + Math.floor(C/4);
    J = J - 7*Math.floor(J/7);
    var L = I - J;
    var M = 3 + Math.floor((L + 40)/44);
    var D = L + 28 - 31*Math.floor(M/4);

    return [M, D]
}

window.isEaster = false;

var now = new Date();
var easter = Easter(now.getFullYear());
if (now.getMonth() + 1 == easter[0] && now.getDate() >= easter[1] - 7 && now.getDate() <= easter[1]){
    isEaster = true;
}

window.randint = function(a, b){
    return Math.floor(a + (Math.random() * (b - a)));
}

window.phase = 1; // Unlock new levels by doing a good job.
window.levelsBeaten = 0; // Beat 2 levels to go to the next phase.
window.phases = [
    [
        /*{
            id: 2500,
            name: "test",
            func: function(g){
                g.createByTileset(0, 0, test);
            }
        },
        {
            id: 178,
            name: "Town of Arimoria, Gunther's Waste",
            func: function(g){
                g.createByTileset(-5, -5, cave_2, ["<h2>Unwelcome to sunny Arimoria!</h2> <br /> 'The sooner you leave, the less likely you are to die here.' <br /><br />Read the signs for explanations.", "This is the famous Fountain of Pain and Suffering. From it's murky depths spring the waters of unholy pestilince, colored red and chasing after you for your convenience."]);
            }
        },*/
        /*{
            id: 6578,
            name: "Hunt",
            func: function(g){
                g.createByTileset(-5, 5, hunt);
            }
        },*/
        /*{
            id: 2545653,
            name: "Flappy",
            func: function(g){
                context = getLevelmakerContext(g);
                context.offset(-2, 5);
                context.flightPowerup(1, -1);
                context.flightPowerup(2, -1);
                context.flightPowerup(3, -1);
                context.box(0, -21, 130, 21);
                for (var i = 0; i < 4; i ++){
                    context.holePylon(10 + (i * 10), -20, 20, window.randint(3, 10), 7);
                }
                for (var i = 0; i < 5; i ++){
                    context.holePylon(50 + (i * 10), -20, 20, window.randint(3, 10), 6);
                }
                for (var i = 0; i < 3; i ++){
                    context.holePylon(100 + (i * 10), -20, 20, window.randint(3, 10), 5);
                }
            }
        },*/
        {
            id: 7,
            name: "Training",
            func: function(g){
                g.createByTileset(-2, 0, training, ["Look - lava! Sail over it with the 'up' and 'right' keys to avoid dying.", "As you can see, these are coins. Run into them to claim them, you'll notice you gain a score counter!<br /> The moving lava below you will hurt you just as bad as normal lava, so you should make sure to dodge it when you try to get the coin.", "The yellow blocks are jump-through platforms. You pass through them when you hit them from the bottom, and you can fall back through them with the down arrow key!", "The blue tiles are ice. You'll find they're very slippery!", "This is a Bat. It clings to the cave walls until you drop next to it, then flies after you. It will kill you if it touches you, and will eat your coins if it touches them. I put a force field in place that keeps it from touching you up here, so you can try activating it.", "You see the blue things? Those are bomb power-up orbs. If you run into them, you'll eat them and increase your bomb count (hover the grey thing in the corner to see your bomb count). Then, you can click space and drop a Bomb that kills active Bats and Vladimirs. Use a bomb's explosion to kill the bats before they eat your coins, but remember to wake them up first!", "Some power-up orbs (orange instead of blue) give Shielding instead of Bombs. This is one of them! Pick it up, you'll see a blue glow and the shielding statbar will turn partially red, and start declining. Try and hit the lava while shielded; you'll touch it like it is a normal Solid brick! Do be careful fighting more persistent enemies like Bats with shielding, the shield eventually drops and you'll be in big trouble, and they can hold you in place.", "The maroon power-up orb is for flight! You'll be able to jump infinitely in mid-air while the bar remains.", "The purple thing is a switchblock. It doesn't do much, but when you go through it, some other blocks turn transparent and stop blocking your way, allowing you to touch the power-ups on the next platform!", "See the gold power-up orb? That's a key! Grab it to unlock the ending. Now see how the sunflower is opaque again? That's the end of the level. Run into it to exit back to the main menu, you'll notice this level will be gone! Once you beat every level on the menu, you will advance to phase 2 and more will appear."])
                g.createSign(1, 1, "Welcome to Platformer! This is a short, simple training level designed to get you on your feet.<br />What you have hovered is a sign. You should always hover them, they have useful information.<br />To start out, try moving the player with the left and right arrow keys", "Mouse Over Me")
                var cont = window.getLevelmakerContext(g);
                cont.offset(-2, 0);
                cont.sensorDoors(
                    [
                        {
                            x: 125,
                            y: 32
                        }
                    ],
                    [
                        {
                            x: 130,
                            y: 32,
                            height: 4
                        },
                        {
                            x: 131,
                            y: 32,
                            height: 1,
                            width: 8
                        },
                        {
                            x: 138,
                            y: 33,
                            height: 3,
                            width: 1,
                        }
                    ], true
                )
            }
        },
        {
            id: 6,
            name: "Tiny Maze",
            func: function(g){
                g.createByTileset(-2, 0, tinymaze);
            }
        },
        {
            id: 8,
            name: "Fortress",
            func: function(g){
                g.createByTileset(-2, -5, fortress);
            }
        }
    ],
    [
        {
            id: 20,
            name: "New Features Wonderland",
            func: function(g){
                g.createByTileset(-2, -5, new_features_wonderland)
            }
        },
        {
            id: 10,
            name: "Office",
            func: function(g){
                g.createByTileset(0, 0, office, ["Well, it's bad. It looks like the lavas have taken over the office complex! Get to the top as fast as possible, so you can dump all of these lavas to Garbage Collection."]);
            }
        },
        {
            id: 5,
            name: "An Actual Maze This Time",
            func: function(g){
                g.createByTileset(-5, -5, actual_maze, ["This one is a real maze. There is only one way out. Best of luck!", "Ah yes. Looks like you've found the less painful way out! I recommend you take a temporary detour, you'll get plenty coins that way.", "You didn't find the easy route at all. Haha!", "This is the end of the level."]);
            }
        }
    ],
    [
        {
            id: 177,
            name: "Entrance to Gunther's Wastes",
            func: function(g){
                g.createBrick(9, 0, 14, 6, "shadows", "");
                g.createBrick(48, 9, 8, 2, "shadows", "");
                g.createByTileset(-5, -5, cave_1, ["<h2>Welcome to Gunther's Wastes (home of Gunther's Cave)</h2>Population: whoever is dumb enough to enter <br />Exports: plague, mutant enemies, grapefruit<br />Imports: shadows, death-mites, human souls<br />Motto: 'DEAR GOD PLEASE HELP ME I'VE BEEN STUCK FOR YEARS'<br />Accomodations: Trees, rocks, and racks are to be found all throughout.<br /><h4>Enjoy your stay!</h4>"]);
            }
        },
        {
            id: 20000,
            name: "Flats of Gunther's Waste",
            func: function(g){
                g.createByTileset(-3, 5, cave_2);
            }
        }
    ],
    [
        {
            id: 1,
            name: "The Plains",
            func: function(g){
                g.createByTileset(-5, 6, the_plains, ["Beware! This is a junction! The original creator designed what you will find if you go down, another designed what you will find if you keep on going this way. Neither play is revocable. Choose your poison!"]);
            }
        },
        {
            id: 4,
            name: "The Basement",
            func: function(g){
                g.createByTileset(-3, -6, lvl2, ["You have a superpower. An extra jump! Slide off a platform without jumping and you can jump in mid-air to fly."]);
            }
        }
    ]
];

function getLevelmakerContext(g) {
    return {
        game: g,
        xOffset: 0,
        yOffset: 0,
        offset: function(x, y){
            this.xOffset = x;
            this.yOffset = y;
        },
        normal: function(x, y, width, height){
            this.game.createBrick(x + this.xOffset, y + this.yOffset, width, height, "regular", "solid");
        },
        toothbrushTrap: function(x, y, prongs, alignment = 1){
            var height = prongs * 3 + 2;
            this.game.createBrick(x + this.xOffset, y - height + this.yOffset, 1, height, "lava", "killu");
            for (var i = 0; i < prongs; i ++){
                this.game.createBrick(x + alignment + this.xOffset, y - ((i + 1) * 3) - 1 + this.yOffset, 1, 1, "regular", "solid");
            }
        },
        squaretrap: function(x, y, width, height){
            this.game.createBrick(x + this.xOffset,         y + this.yOffset - 1, 1, 1, "lava", "killu");
            this.game.createBrick(x + this.xOffset,         y + this.yOffset - 1 - height, 1, 1, "lava", "killu");
            this.game.createBrick(x + this.xOffset + width, y + this.yOffset - 1 - height, 1, 1, "lava", "killu");
            this.game.createBrick(x + this.xOffset + width, y + this.yOffset - 1, 1, 1, "lava", "killu");
        },
        cupTrap: function(x, y, width, height){
            this.normal(x, y, 1, height);
            this.normal(x, y + height, width - 1, 1);
            this.normal(x + width, y, 1, height);
            this.game.createBrick(x - 1 + width + this.xOffset, y + this.yOffset + height, 2, 1, "lava", "killu");
        },
        holePylon: function(x, y, height, holePos, holeSize, renderType="lava", type="killu"){
            this.game.createBrick(x + this.xOffset, y + this.yOffset,                      1, holePos,                     renderType, type);
            this.game.createBrick(x + this.xOffset, y + this.yOffset + holePos + holeSize, 1, height - holeSize - holePos, renderType, type);
        },
        shieldPowerup: function(x, y){
            x += this.xOffset;
            y += this.yOffset;
            this.game.createBrick(x, y, 1, 1, "powerup", "shieldPowerup");
        },
        flightPowerup: function(x, y){
            x += this.xOffset;
            y += this.yOffset;
            this.game.createBrick(x, y, 1, 1, "powerup", "flightPowerup");
        },
        box: function(x, y, w, h, type="solid", renderType="regular"){
            x += this.xOffset;
            y += this.yOffset;
            this.game.createBrick(x, y, w, 1, renderType, type);
            this.game.createBrick(x, y, 1, h, renderType, type);
            this.game.createBrick(x + w - 1, y, 1, h, renderType, type);
            this.game.createBrick(x, y + h, w, 1, renderType, type);
        },
        sensorDoor: function(sensorConf, doorConf){
            doorConf.type = doorConf.type || "solid";
            doorConf.renderType = doorConf.renderType || "regular";
            doorConf.width = doorConf.width || 1;
            doorConf.height = doorConf.height || 2;
            sensorConf.x += this.xOffset;
            sensorConf.y += this.yOffset;
            doorConf.x += this.xOffset;
            doorConf.y += this.yOffset;
            var item = this.game.createBrick(sensorConf.x, sensorConf.y, 1, 1, "sensor", "sensor", undefined, {
                slave: this.game.createBrick(doorConf.x, doorConf.y, doorConf.width, doorConf.height, doorConf.renderType, doorConf.type)
            });
            console.log(item.options);
            item.options.slave.options.master = item;
        },
        sensorDoors: function(sensors, doors, isOpen = false){
            var doorBricks = [];
            doors.forEach((door) => {
                door.x += this.xOffset;
                door.y += this.yOffset;
                door.type = door.type || "solid";
                door.renderType = door.renderType || "regular";
                door.width = door.width || 1;
                door.height = door.height || 2;
                var doorBrick = this.game.createBrick(door.x, door.y, door.width, door.height, door.renderType, door.type);
                if (isOpen){
                    doorBrick.element.classList.remove("transparent");
                }
                else{
                    //console.log(slave);
                    doorBrick.element.classList.add("transparent");
                }
                doorBricks.push(doorBrick);
            });
            var switchBlocks = [];
            sensors.forEach((sensor) => {
                sensor.x += this.xOffset;
                sensor.y += this.yOffset;
                var switchBlock = this.game.createBrick(sensor.x, sensor.y, 1, 1, "sensor", "sensor", undefined, {
                    slave: doorBricks,
                    state: isOpen
                });
                switchBlocks.push(switchBlock);
            });
            switchBlocks.forEach((item, i) => {
                item.options.comrades = switchBlocks;
            });
            doorBricks.forEach((item, i) => {
                item.options.master = switchBlocks[0];
            });
        },
        normalEnemy: function(x, y, width=1, height=1){
            this.game.specials.push({
                type: "normal",
                brick: this.game.createBrick(x, y, width, height, "lava enemy", "killu"),
                speed: 5,
                yv: 0
            });
        }
    }
}

function testLevel(context){
    context.setOffset(0, 4);
    context.makeNormal(0, 0, 14, 1);
    context.makeToothbrushTrap(4, 0, 1, -1);
    context.makeSquaretrap(8, 0, 3, 100);
    context.makeCupTrap(14, 0, 5, 5);
}


class Brick{
    constructor(x,y,width,height, scale,renderclass,type,text,visibleText,probability, options){
        this.options = options || {}; // If options == undefined, use an empty object.
        this.x1=x;
        this.y1=y;
        this.x2=x+width; // For collisions
        this.y2=y+height; // For collisions
        this.probprob = probability || 1;
        this.element=document.createElement("div");
        document.getElementById("game-main").appendChild(this.element);
        this.element.className=renderclass+" "+type+" "+" brick";
        this.element.style.width=width.toString()+"px";
        this.element.style.height=height.toString()+"px";
        this.element.style.left=this.x1.toString()+"px";
        this.element.style.top=this.y1.toString()+"px";
        var elem = document.createElement("div");
        this.element.appendChild(elem);
        if (text!=undefined){
            elem.innerHTML = text;
        }
        if (visibleText!=undefined){
            var elem = document.createElement("div");
            this.element.appendChild(elem);
            elem.innerHTML = visibleText;
        }
        this.type=type;
        this.needsDomRefresh = false;
        this.scale = scale;
    }
    move(xm,ym){
        this.x1+=xm;
        this.y1+=ym;
        this.x2+=xm;
        this.y2+=ym;
        this.needsDomRefresh = true;
    }
    apply(){
        if ((this.x1 < window.innerWidth || this.x2 > 0) && (this.y1 < window.innerHeight || this.y2 > 0) && this.needsDomRefresh){ // Don't do a dom operation unless the brick is visible
            this.element.style.left=((this.x1)).toString()+"px";
            this.element.style.top=((this.y1)).toString()+"px";
            this.needsDomRefresh = false;
        }
    }
    remove(){
        this.element.parentNode.removeChild(this.element);
    }
}


class Player {
    #xv;
    #yv;
    #cheat;

    constructor(mobile,width,height,game){
        if (mobile){
            this.joystick = new JoyStick({radius: window.innerHeight/8, x: window.innerWidth - window.innerHeight/8, y: window.innerHeight * 7/8, inner_radius: window.innerHeight/8 - 10})
        }
        this._shieldDuration = 0;
        this._flightDuration = 0;
        this.width=width
        this.height=height
        this.game=game
        this.element=document.createElement("div");
        document.getElementById("game-main").appendChild(this.element);
        this.element.style.width=(width-1).toString()+"px";
        this.element.style.height=(height-1).toString()+"px";
        this.element.style.top=(window.innerHeight/2 - height/2).toString()+"px";
        this.element.style.left=(window.innerWidth/2 - width/2).toString()+"px";
        this.element.id="player";
        if (window.isEaster){
            var el = document.createElement("img");
            el.src="res/bunny_ears.png";
            el.classList.add("bunny");
            this.element.appendChild(el);
        }
        this.element.appendChild(document.createElement("span"));
        this.#xv=0;
        this.#yv=0;
        this.rightpressed=false;
        this.leftpressed=false;
        this.onground=true;
        this.score=0;
        this.bombs = 0;
        var rect=this.element.getBoundingClientRect();
        this.x1 = rect.left;
        this.y1 = rect.top;
        this.x2 = rect.right;
        this.y2 = rect.bottom;
        this.jumpThroughing = false;
        // Developer mode stuff
        this.lock = "ghc1";
        this.checkPointNum = 0;
        this.#cheat = {
            active: false,
            devView: false,
            phaser: 0, // 0 = nothing, 1 = waiting for collision to phase through, 2 = phasing through
            invincible: false,
            collidesWithLava: false,
            flying: false
        }
        this.gravity = 1;
        this.touchingBlock = false;
        this.touchingX = false;
        this.touchingY = false;
        this.slipping = false;
        this.stuck = false;
        this.touchingGreen = false;
        this.maxShielding = 1000;
        this.maxFlight = 1000;
    }
    set shieldDuration(newVal){
        if (newVal < this.maxShielding){
            this._shieldDuration = newVal;
        }
        else{
            this._shieldDuration = this.maxShielding;
        }
    }
    get shieldDuration(){
        return this._shieldDuration;
    }
    set flightDuration(newVal){
        if (newVal < this.maxFlight){
            this._flightDuration = newVal;
        }
        else{
            this._flightDuration = this.maxFlight;
        }
    }
    get flightDuration(){
        return this._flightDuration;
    }
    remove(){
        this.element.parentNode.removeChild(this.element);
        this.bombs = 0; // Reset the stats section.
        //this.shieldDuration = 0;
        this.refreshstats();
    }
    onkeyup(event){
        if (event.key == this.lock[this.checkPointNum]){
            this.checkPointNum ++;
            if (this.checkPointNum == this.lock.length){
                this.#cheat.active = true;
                alert("All cheats unlocked!");
            }
        }
        else{
            this.checkPointNum = 0;
        }
        if (event.key == "a" || event.key == "ArrowLeft"){
            this.leftpressed=false;
        }
        else if (event.key == "d" || event.key == "ArrowRight"){
            this.rightpressed=false;
        }
        else if (event.key == " "){
            this.DropBomb();
        }
        if (this.#cheat.active){
            switch (event.key){
                case "r":
                    this.#cheat.devView = !this.#cheat.devView;
                    if (this.#cheat.devView){
                        document.getElementById("game-main").classList.add("revalio");
                    }
                    else{
                        document.getElementById("game-main").classList.remove("revalio");
                    }
                    break;
                case "i":
                    this.shieldDuration = Infinity;//this.#cheat.invincible = !this.#cheat.invincible;
                    break;
                case "g":
                    this.gravity *= -1;
                    break;
                case "s":
                    this.#cheat.phaser = 1;
                    break;
                case "j":
                    this.#yv = -5 * this.gravity;
                    break;
                case "f":
                    this.flightDuration = Infinity;
                    break;
                case ".":
                    this.#xv *= 10;
                    break;
                case "a":
                    this.game.arbitraryRestructure();
                    break;
            }
        }
        if (event.key === "p"){
            alert("Paused. Click out of this alert box when you are ready to begin again.");
        }
    }
    onkeydown(event){
        console.log(event.key);
        if (event.key == "w" || event.key == "ArrowUp"){
            this.Jump();
        }
        else if (event.key == "ArrowDown" && (this.#cheat.flying || this.flightDuration > 0)){
            this.#yv = 20 * this.gravity;
        }
        else if (event.key == "a" || event.key == "ArrowLeft"){
            this.leftpressed=true;
        }
        else if (event.key == "d" || event.key == "ArrowRight"){
            this.rightpressed=true;
        }
        if (event.key == "ArrowDown" || event.key == "s"){
            this.DropThrough();
        }
    }
    run(){
        if (this.shieldDuration > 0){
            this.shieldDuration --; // This is the same thing as the phase code in the enemies; it ticks down one every pass until it reaches zero.
        }
        if (this.flightDuration > 0){
            this.flightDuration --;
        }
        if (this.leftpressed || (this.joystick && this.joystick.left)){
            this.Left();
        }
        if (this.rightpressed || (this.joystick && this.joystick.right)){
            this.Right();
        }
        if (this.joystick && this.joystick.up && this.onground){
            this.#yv = -20 * this.gravity;
            this.onground = false;
        }
        this.game.move(0,this.#yv);
        colis=this.game.checkCollision();
        if (colis["end"] > 0 && this.game.keysCount == 0){
            this.game.win = true;
        }
        if (colis["tencoin"] > 0){
            this.score+=colis["tencoin"]*10;
            this.refreshscore();
        }
        if (colis["shieldPowerup"] > 0){
            this.shieldDuration = 250;
            this.refreshstats();
        }
        if (colis["flightPowerup"] > 0){
            this.flightDuration = 250;
        }
        if (colis["jumpthrough"] > 0 && colis["solid"] == 0){
            if (this.#yv < 0){
                this.jumpThroughing = true;
            }
        }
        else if (this.#yv >= 0){
            this.jumpThroughing = false;
        }
        if (colis["fiftycoin"] > 0){
            this.score+=colis["fiftycoin"]*50;
            this.refreshscore();
        }
        if (colis["green"] > 0){
            this.touchingGreen = true;
        }
        else{
            this.touchingGreen = false;
        }
        if ((colis["pedanticsolid"] > 0 || (colis["killu"] > 0 && this.#cheat.invincible)) && !this.jumpThroughing){
            if (this.#cheat.phaser == 1){
                this.#cheat.phaser = 2;
            }
            else if (this.#cheat.phaser != 2){
                while (this.game.checkCollision()["pedanticsolid"]/* + colisifiaction["jumpthrough"]*/ > 0){
                    this.game.move(0,this.#yv/Math.abs(this.#yv) * -1);
                }
                if (this.#yv*this.gravity > 0){
                    this.onground=true;
                }
                this.#yv=0;
                if (colis["ice"] > 0){
                    this.slipping = true;
                }
                else{
                    this.slipping = false;
                }
                if (colis["tar"] > 0){
                    this.stuck = true;
                }
                else {
                    this.stuck = false;
                }
            }
            this.touchingBlock = true;
            this.touchingY = true;
        }
        else if (this.#cheat.phaser == 2){
            this.#cheat.phaser=0;
        }
        else{
            this.touchingBlock = false;
            this.touchingY = false;
            this.slipping = false;
        }
        this.game.move(this.#xv,0);
        var colis=this.game.checkCollision();
        if (colis["end"] > 0 && this.game.keysCount == 0){
            this.game.win = true;
        }
        if (colis["tencoin"] > 0){
            this.score+=colis["tencoin"]*10;
            this.refreshscore();

        }
        if (colis["killu"] > 0 && !this.#cheat.invincible){
            this.end();
        }
        if (colis["fiftycoin"] > 0){
            this.score+=colis["fiftycoin"]*50;
            this.refreshscore();
        }
        if (colis["shieldPowerup"] > 0){
            this.shieldDuration += 250;
        }
        if (colis["flightPowerup"] > 0){
            this.flightDuration += 250;
        }
        if (colis["powerup"] > 0){
            this.bombs ++;
            this.refreshstats();
        }
        if (colis["solid"] > 0/* && !this.jumpThroughing*/){
            if (this.#cheat.phaser == 1){
                this.#cheat.phaser = 2;
            }
            else if (this.#cheat.phaser == 2){
                // Nothing!
            }
            else{
                while (this.game.checkCollision()["solid"] > 0){ // If it made it this far, treat killu as solid. This is the patch for another bug, actually, so everybody is happy.
                    this.game.move(this.#xv/Math.abs(this.#xv) * -1, 0);
                }
                this.#xv=0;
            }
            this.touchingBlock = true;
            this.touchingX = true;
        }
        else if (this.#cheat.phaser == 2){
            this.#cheat.phaser=0;
        }
        else {
            this.touchingX = false;
        }
        this.#xv*=this.slipping ? 1 : (this.stuck ? 0.4 : 0.8);
        if (this.#cheat.flying){
            this.#yv *= 0.8
        }
        else{
            this.#yv += this.touchingGreen ? -1 * this.gravity : this.gravity;
        }
        this.wentLeft = false;
        this.wentRight = false;
        this.refreshstats();
    }
    end(){
        window.alert("Your final score: " + this.score);
        this.game.die = true;
    }
    refreshscore(){
        this.element.querySelector("span").innerText=this.score.toString();
    }
    refreshstats(){
        document.getElementById("ammocount").innerHTML = "Bombs: " + this.bombs;
        document.querySelector("#shielding > div > span").style.width = (200 * this.shieldDuration/this.maxShielding) + "px";
        document.querySelector("#flight > div > span").style.width = (200 * this.flightDuration/this.maxFlight) + "px";
        if (this.shieldDuration > 0){
            this.element.classList.add("umbra");
        }
        else {
            this.element.classList.remove("umbra");
        }
    }
    Jump(){
        if (this.onground || this.#cheat.flying || this.flightDuration > 0){
            this.#yv=-20 * this.gravity;
            this.onground=false;
        }
    }
    Left(){
        if (!this.wentLeft){
            this.#xv += this.slipping ? 0.75 : (this.flightDuration > 0 ? 4 : 2);
            this.wentLeft = true;
        }
    }
    Right(){
        if (!this.wentRight){
            this.#xv -= this.slipping ? 0.75 : (this.flightDuration > 0 ? 4 : 2);
            this.wentRight = true;
        }
    }
    DropBomb(){ // Drop a bomb.
        if (this.bombs > 0){
            this.bombs --;
            this.refreshstats();
            this.game.specials.push({
                type: "bomb",
                brick: this.game.createBrick(-0.5, 0, 1, 1, "bomb", "bomb"),
                timeLeft: 50,
                yv: 0
            });
        }
    }
    DropThrough(){
        this.jumpThroughing = true;
    }
}


class RobotPlayer extends Player {
    constructor(mobile,width,height,game){
        super(mobile, width, height, game);
        this.RobotInit();
        this.oldScore = 0;
    }
    onkeyup(event){
        console.log("Right now, the player is a robot and will not respond to any keypresses. Please change your game constructor at the start of the code.");
    }
    onkeydown(event){

    }
    run(){
        super.run();
        this.RobotRun();
    }
    LookForLava(){
        var ret = [];
        this.game.bricks.forEach((item, i) => {
            if (this.x1 - 100 < item.x2 &&
                this.x2 + 100 > item.x1 &&
                this.y1 - 100 < item.y2 &&
                this.y2 + 100 > item.y1 &&
                item.type == "killu"    &&
                !item.element.classList.contains("enemy")){
                    ret.push([item.x1 - this.x1, item.y1 - this.y1, item.x2 - this.x1, item.y2 - this.y1]);
                }
        });
        return ret;
    }
    LookForEnemies(){
        var ret = [];
        this.game.enemies.forEach((thing, i) => {
            var item = thing[0];
            if (this.x1 - 100 < item.x2 &&
                this.x2 + 100 > item.x1 &&
                this.y1 - 100 < item.y2 &&
                this.y2 + 100 > item.y1 &&
                item.type == "killu"    &&
                item.element.classList.contains("enemy")){
                    ret.push([item.x1 - this.x1, item.y1 - this.y1, item.x2 - this.x1, item.y2 - this.y1, thing[1]]);
                }
        });
        return ret;
    }
    LookForBlocks(){
        var ret = [];
        this.game.enemies.forEach((thing, i) => {
            var item = thing[0];
            if (this.x1 - 100 < item.x2 &&
                this.x2 + 100 > item.x1 &&
                this.y1 - 100 < item.y2 &&
                this.y2 + 100 > item.y1 &&
                item.type == "solid"){
                    ret.push([item.x1 - this.x1, item.y1 - this.y1, item.x2 - this.x1, item.y2 - this.y1, thing[1]]);
                }
        });
        return ret;
    }
    // These functions below have to be overridden.
    RobotInit(){

    }
    RobotRun(){
        //this.#xv -= 1;
    }
    cheat(){
        alert("That is cheating and against the rules. You are disqualified.");
        this.game.die = true;
    }
    set xv(newVal){
        this.cheat();
    }
    /*set score(newVal){
        this.cheat();
    }*/
    set yv(newVal){
        this.cheat();
    }
    get gotCoin(){
        if (this.score > this.oldScore){
            this.oldScore = this.score;
            return true;
        }
        return false;
    }
}


class FortressRobot extends RobotPlayer{
    RobotInit(){
        this.ticker = 0;
    }
    RobotRun(){
        /*this.Right();
        if (this.touchingX){
            this.Jump();
        }
        alert(this.GetX());*/
        if (this.touchingBlock){
            this.Right();
        }
        if (this.touchingX){
            this.Jump();
        }
        var lavas = this.LookForLava();
        var didLava = false;
        if (lavas.length == 0){
            var enemies = this.LookForEnemies();
            enemies.forEach((item, i) => {
                if (item[4] > 0){
                    this.Left();
                }
                else {
                    if (!(this.game.x < -1900 && this.game.x > -2250)){
                        this.Right();
                    }
                    else {
                        alert("Silence!");
                        this.Left();
                    }
                    this.Jump();
                }
            });
        }
        lavas.forEach((item, i) => {
            if (item[2] > -5 && item[0] < 80){ // It's less than <n> pixels away
                this.Right();
                if (!(this.game.x < -2200 && this.game.x > -2250)){
                    this.Jump();
                }
                else{
                    this.Left();
                }
                didLava = true;this.maxShielding
            }
        });
    }
}


class TrainingRobot extends RobotPlayer {
    RobotInit(){
        this.ticklies = 0;
    }
    RobotRun(){
        /*this.Right();
        if (this.touchingX){
            this.Jump();
        }
        alert(this.GetX());*/
        if (this.touchingBlock){
            this.Right();
        }
        if (this.touchingX){
            this.Jump();
        }
        var lavas = this.LookForLava();
        var didLava = false;
        lavas.forEach((item, i) => {
            if (item[2] > -5 && item[2] < 80){ // It's less than <n> pixels away
                this.Right();
                this.Jump();
                didLava = true;
            }
        });
        var enemies = this.LookForEnemies();
        enemies.forEach((item, i) => {
            if (item[4] > 0){
                this.Left();
            }
            else {
                this.Right();
                this.Jump();
            }
        });
        if (!this.touchingBlock && this.game.x > -2700 && this.game.x < -100){
            if (this.ticklies < 40){
                this.ticklies ++;
            }
            else {
                this.Jump(); // Take the airjump
                this.Right();

            }
        }
    }
}


class TinymazeRobot extends RobotPlayer{
    RobotInit(){
        this.state = 0;
        this.ticker = 0;
    }
    RobotRun(){
        /*this.Right();
        if (this.touchingX){
            this.Jump();
        }
        alert(this.GetX());*/
        if (this.state == 0 || this.state == 1){
            var lavas = this.LookForEnemies();
            if (this.touchingY){
                if (lavas.length == 0){
                    if (this.game.x > -825){
                        this.Right();
                    }
                    else{
                        if (this.game.x < -825){
                            this.Left();
                        }
                        this.Jump();
                        this.state = 1;
                    }
                }
                else if (lavas[0][0] > 0){ // It can only encounter one lava at a time on this level
                    this.Left();
                }
            }
            if (this.touchingX){
                this.Jump();
                this.Right();
            }
            if (this.state == 1){
                if (this.game.y > -150){
                    this.state = 2;
                }
            }
        }
        else if (this.state == 2){
            var enemies = this.LookForEnemies();
            enemies.forEach((item, i) => {
                if (item[0] > -65){ // 50 (player width) + 15 (margin)
                    this.Jump();
                }
            });
            //this.Right();
            //if (this.game.x < -1500){
                this.state = 3;
            //}
        }
        else if (this.state == 3){
            if (this.game.x < -925){
                this.Left();
            }
            if (this.game.x > -925){
                this.Right();
                if (this.touchingY){
                    this.state = 3.2;
                }
            }
        }
        else if (this.state == 3.2){
            this.Jump();
            if (this.game.x < -775){
                this.Left();
            }
            if (this.game.x > -775){
                this.Right();
                if (this.touchingY){
                    this.state = 3.3;
                }
            }
        }
        else if (this.state == 3.3){
            this.ticker ++;
            if (this.touchingY){
                this.state = 3.5;
                this.ticker = 0;
                this.Jump();
            }
        }
        else if (this.state == 3.5){
            if (this.game.x < -1525){
                this.Left();
                if (this.touchingY){
                    this.state = 5;
                }
            }
            if (this.game.x > -1525){
                this.Right();
            }
        }
        else if (this.state == 4){
            this.ticker ++;
            if (this.ticker > 10){
                this.state = 5;
            }
        }
        else if (this.state == 5){
            if (this.game.x < -1575){
                this.Left();
                this.state = 6;
                console.log(this.gotCoin);
            }
            if (this.game.x > -1575){
                this.Right();
            }
        }
        else if (this.state == 6){
            this.Jump();
            this.Left();
            if (this.gotCoin){
                this.state = 7;
                this.ticker = 0;
            }
        }
        else if (this.state == 7){
            if (this.touchingY){
                this.state = 8;
            }
        }
        else if (this.state == 8){
            this.ticker ++;
            if (this.ticker > 30){
                this.state = 9;
            }
        }
        else if (this.state == 9){
            this.Right();
            this.Jump();
        }
    }
}


class PrivateTestRobot extends RobotPlayer{
    pidTo(pos){
        if (this.game.x > pos){
            this.Right();
        }
        else{
            this.Left();
        }
        if (this.game.x > pos - 2 && this.game.x < pos + 2){
            return true;
        }
        return false;
    }
    RobotInit(){
        this.phase = 0;
        this.ticker = 0;
    }
    RobotRun(){
        if (this.phase == 0){
            if (this.pidTo(-200)){ // pidTo uses the limited functions I made available (this is for a virtual robotics competition I'm hosting) to get as close to a certain point as possible.
                this.phase = 1;
            }
        }
        else if (this.phase == 1){
            this.Jump();
            this.phase = 2;
        }
        else if (this.phase == 2){
            if (this.pidTo(-430) && this.touchingY){ // Each block is 50, so this goes 4 blocks forwards. All the coordinates are reversed.
                this.phase = 3;
            }
        }
        else if (this.phase == 3){
            this.ticker ++;
            this.Jump();
            if (this.ticker > 10){
                this.phase = 4;
                this.ticker = 0;
            }
        }
        else if (this.phase == 4){
            if (this.pidTo(-700)){
                this.phase = 5;
            }
        }
        else if (this.phase == 5){
            this.Jump();
            this.phase = 6;
        }
        else if (this.phase == 6){
            this.Right();
            if (this.touchingY){
                this.phase = 7;
            }
        }
        else if (this.phase == 7){
            this.Right();
            if (!this.touchingY){
                this.phase = 8;
                console.log(this.gotCoin);
            }
        }
        else if (this.phase == 8){
            if (this.touchingY){
                this.phase = 8.5;
            }
        }
        else if (this.phase == 8.5){
            this.Jump();
            this.Left();
            if (this.touchingX){
                this.phase = 9;
            }
        }
        else if (this.phase == 9){
            this.Right();
            if (this.touchingY){
                this.phase = 10;
            }
        }
        else if (this.phase == 10){
            if (!this.gotCoin){
                this.phase = 8;
                //this.Right();
            }
            else{
                this.phase = 11;
            }
        }
        else if (this.phase == 11){
            this.Right();
        }
    }
}


class Game{
    constructor(mobile, multiplayer, playerClass = Player, xoffset=0,yoffset=0,brickwidth=50,brickheight=50){
        this.win = false;
        this.die = false;
        this.bricks=[];
        this.minigames=[];
        this.xoffset=0;
        this.yoffset=0;
        this.brickWidth=brickwidth;
        this.brickHeight=brickheight;
        this.player=new playerClass(mobile, 49,99,this);
        window.player = this.player;
        this.onkeyup = (event) => {
            this.player.onkeyup(event);
        };
        this.onkeydown = (event) => {
            this.player.onkeydown(event);
        };
        window.addEventListener('keydown', this.onkeydown);
        window.addEventListener("keyup", this.onkeyup);
        this.minigame = document.getElementById("minigame");
        this.minigameTick = 0;
        this.minigamePlaying = null;
        this.specials = [];
        this.probPassers = [];
        this.runningEnemies = true;
        this.checkPoints = [];
        this.y = 0;
        this.x = 0;
        this.scale = 1;
        this.minExtent = 6000;
        document.getElementById("game-main").classList.add("playing");
        this.keysCount = 0;
        this.endings = [];
        this.unstables = []; // Unstables delete when all keys are collected.
    }
    arbitraryRestructure(){

    }
    _createBrick(x,y,width,height,renderclass,type,text,visibleText, probability, options){
        var x = new Brick(x+window.innerWidth/2+this.xoffset,y+window.innerHeight/2+this.yoffset,width,height, this.scale,renderclass,type,text,visibleText, probability, options);
        this.bricks.push(x);
        return x;
    }
    createBrick(x,y,horizLen, height, renderclass="regular",type="solid", probability, options){
        return this._createBrick(x*this.brickWidth,y*this.brickHeight,this.brickWidth * horizLen,this.brickHeight * height,renderclass,type, undefined, undefined, probability, options);
    }
    createHorizontal(x,y,width,renderclass="regular",type="solid"){
        this._createBrick(x*this.brickWidth,y*this.brickHeight,width*this.brickWidth,this.brickHeight,renderclass,type);
    }
    createVertical(x,y,height,renderclass="regular",type="solid"){
        this._createBrick(x*this.brickWidth,y*this.brickHeight,this.brickWidth,height*this.brickHeight,renderclass,type);
    }
    createSquare(x,y,width,height,renderclass="regular",type="solid"){
        this._createBrick(x*this.brickWidth,y*this.brickHeight,width*this.brickWidth,height*this.brickHeight,renderclass,type);
    }
    createSign(x,y,text,visibleText){
        this._createBrick(x * this.brickWidth, y * this.brickHeight, this.brickWidth, this.brickHeight, "sign", "notsolid", text,visibleText);
    }
    createMinigameBlock(x, y, minigameType){
        this._createBrick(x * this.brickWidth, y * this.brickWidth, this.brickWidth, this.brickHeight, "minigame", "minigame", undefined, undefined, minigameType);
    }
    createByLetter(x, y, width, height, letter){
        switch (letter) {
            case "r": // Regular, old - toy - story block.
                this.createBrick(x, y, width, height);
                break;
            case "c": // Coins
                this.createBrick(x, y, width, height, "tencoin", "tencoin")
                break;
            case "l": // Lava
                this.createBrick(x, y, width, height, "lava", "killu");
                break;
            case "C": // Big Coins
                this.createBrick(x, y, width, height, "fiftycoin", "fiftycoin");
                break;
            case "f":
                this.createBrick(x, y, width, height, "lava", "notsolid");
                break;
            case "F":
                this.createBrick(x, y, width, height, "regular", "notsolid");
                break;
            case "I":
                this.createBrick(x, y, width, height, "invisible", "killu");
                break;
            case "e":
                this.specials.push({
                    type: "normal",
                    brick: this.createBrick(x, y, 1, 1, "lava enemy", "killu"),
                    speed: 5,
                    yv: 0
                });
                break;
            case "E":
                this.specials.push({
                    type: "normal",
                    brick: this.createBrick(x, y, 1, 1, "lava enemy", "killu"),
                    speed: 10,
                    yv: 0
                });
                break;
            case "L":
                this.createBrick(x, y, width, height, "lava", "killu_nocol")
            case "ǝ":
                this.specials.push({
                    type: "normal",
                    brick: this.createBrick(x, y, 1, 1, "lava enemy", "killu"),
                    speed: -5,
                    yv: 0
                });
                break;
            case "z":
                this.createBrick(x, y, width, height, "invisible", "elevator");
                break;
            case "Z":
                this.createBrick(x, y, width, height, "invisible", "bigElevator");
                break;
            case "v":
                this.createBrick(x, y, width, height, "invisible", "notsolid");
                break;
            case "p":
                this.createBrick(x, y, width, height, "invisible", "zapwall");
                break;
            case "P":
                this.createBrick(x, y, width, height, "regular", "solid", 0.5);
                break;
            case "d":
                this.createBrick(x, y, width, height, "invisible", "enemyFlipperRight");
                break;
            case "D":
                this.createBrick(x, y, width, height, "invisible", "enemyFlipperLeft");
                break;
            case "k":
                this.keysCount ++;
                this.createBrick(x, y, width, height, "powerup" + (window.isEaster ? " bunny" : ""), "keyPowerup");
                break;
            case "n":
                this.endings.push(this.createBrick(x, y, width, height, "end", "end"));
                break;
            case "j":
                this.createBrick(x, y, width, height, "jumpthrough", "jumpthrough")
                break;
            case "J":
                this.unstables.push(this.createBrick(x, y, width, height, "jumpthrough", "jumpthrough"));
                break;
            case "1":
                this.specials.push({
                    type: "normal",
                    brick: this.createBrick(x + Math.random() * (width - 1), y, 1, 1, "lava enemy", "killu"),
                    speed: -5,
                    yv: 0
                });
                break;
            case "2":
                this.createBrick(x + Math.random() * (width - 1), y, 1, 1, "lava", "killu");
                break;
            case "3":
                this.createBrick(x + Math.random() * (width - 1), y, 1, 1, "regular", "solid");
                break;
            case "S":
                this.createBrick(x, y, width, height, "ice", "ice");
                break;
            case "b":
                this.specials.push({
                    type: "bat",
                    brick: this.createBrick(x, y, 1, 1, "lava bat", "killu"),
                    speed: -5,
                    yv: 0
                });
                break;
            case "t":
                this.createBrick(x, y, width, height, "tar", "tar");
                break;
            case "V":
                this.createBrick(x, y, width, height, "ghostly", "notsolid");
                break;
            case "g":
                this.specials.push({
                    type: "gunner",
                    brick: this.createBrick(x, y, width, height, "gunner", "killu"),
                    mkx: x,
                    mky: y
                });
                break;
            case "B":
                this.specials.push({
                    type: "blaze",
                    brick: this.createBrick(x, y, width, height, "lava", "solid"),
                    mkx: x,
                    mky: y,
                    spurtLength: 100,
                    spurtSpacing: 125,
                    lifetime: 40,
                    phaseLength: 3
                });
                break;
            case "i":
                this.specials.push({
                    type: "blaze",
                    brick: this.createBrick(x, y, width, height, "lava", "solid"),
                    mkx: x,
                    mky: y,
                    spurtLength: Infinity,
                    spurtSpacing: 0,
                    lifetime: 10,
                    phaseLength: 7
                });
                break;
            case "G":
                this.createBrick(x, y, width, height, "green", "green");
                break;
            case "u":
                this.createBrick(x, y, width, height, "powerup", "powerup");
                break;
            case "@":
                this.createBrick(x, y, width, height, "powerup", "shieldPowerup");
                break;
            case "#":
                this.createBrick(x, y, width, height, "powerup", "flightPowerup");
                break;
        }
    }
    createByTileset(x,y,tileset, signs){
        var ix=x;
        var iy=y;
        var curHoriz = 0;
        var curHorizType = undefined;
        var signNum = 0;
        tileset.split("").forEach((item, i) => {
            if (item == "s"){
                this.createSign(ix, iy, signs[signNum]);
                signNum ++;
            }
            else {
                if (curHorizType == item && ["e", "E", "c", "C", "u", "#", "@"].indexOf(item) == -1){
                    curHoriz ++;
                }
                else {
                    this.createByLetter(ix - curHoriz, iy, curHoriz, 1, curHorizType);
                    curHorizType = item;
                    curHoriz = 1;
                }
            }
            ix++;
            if (item == "\n"){
                ix = x;
                iy ++;
                this.minExtent = (iy + 2) * 50;
            }
        });
    }
    createHollowSquare(x,y,width,height,renderclass="regular",type="solid"){
        width-=1;
        height-=1;
        this.createHorizontal(x,y,width,renderclass,type);
        this.createVertical(x,y-height,height,renderclass,type);
        this.createHorizontal(x+1,y-height,width,renderclass,type);
        this.createVertical(x+width,y-height+1,height,renderclass,type)
    }
    move(xm,ym){
        this.bricks.forEach((item, i) => {
            item.move(xm,ym*-1);
        });
        this.x += xm;
        this.y -= ym;
        if (this.y < -this.minExtent){
            this.die = true;
        }
    }
    apply(){
        this.bricks.forEach((item, i) => {
            item.apply();
        });
    }
    checkCollision(object = this.player, holes = false, supercilious = false){ // Collisions are a pixel smaller than they should be, if "holes" = true. Supercilious makes it 2 pixels to account for tidal drag.
        var dictionary={
            "solid":0,
            "notsolid":0,
            "killu":0,
            "tencoin":0,
            "fiftycoin":0,
            "minigame":0,
            "elevator":0,
            "bigElevator":0,
            "end":0,
            "jumpthrough":0,
            "pedanticsolid":0,
            "ice": 0,
            "all":0,
            "green": 0,
            "zapwall": 0,
            "powerup": 0,
            "shieldPowerup": 0,
            "tar":0,
            "flightPowerup": 0,
            "keyPowerup": 0,
            "sensor": 0,
            "elements": []
        };
        var passers = 0;
        if (this.player.shieldDuration > 0){
            this.bricks.push(this.player);
        }
        this.bricks.forEach((item, i) => {
            if (item.probprob != 1){
                passers ++;
            }
            if (((item.x2 >= object.x1 &&
                item.x1 <= object.x2 &&
                item.y2 >= object.y1 &&
                item.y1 <= object.y2 && !holes && !supercilious)
                || (item.x2 > object.x1 &&
                    item.x1 < object.x2 &&
                    item.y2 > object.y1 &&
                    item.y1 < object.y2 && holes && !supercilious)
                    || (item.x2 - 1 > object.x1 &&
                        item.x1 + 1 < object.x2 &&
                        item.y2 > object.y1 &&
                        item.y1 < object.y2 && supercilious)))
            {
                if (item.probprob > Math.random() || item.probprob == undefined){
                    if (item.options == undefined || item.options.master == undefined || item.options.master.options.state){ // Check undefined, then check state
                        dictionary[item.type]++;
                        if (item.type=="tencoin" || item.type=="fiftycoin" || item.type=="powerup" || item.type == "shieldPowerup" || item.type == "flightPowerup" || (item.type == "keyPowerup" && object == this.player)){
                            item.remove();//element.parentNode.removeChild(item.element);
                            this.bricks.splice(i,1);
                            if (item.type == "keyPowerup"){
                                this.keysCount --;
                            }
                        }
                        if (item.type=="minigame"){
                            dictionary["solid"]++;
                            this.playMinigame(item.element.getAttribute("data-minigame"));
                        }
                        if (!(item.type=="elevator" || (item.type == "bigElevator") || item.type == "enemyFlipper" || item.type == "")){
                            if (item.type != "sensor"){
                                dictionary["all"]++;
                            }
                            dictionary["elements"].push(item);
                        }
                        if (item.type == "jumpthrough"){
                            dictionary.pedanticsolid ++;
                        }
                        if (item.type == "solid"){
                            dictionary.pedanticsolid ++;
                        }
                        if (item.type == "ice"){
                            dictionary.solid ++;
                            dictionary.pedanticsolid ++;
                        }
                        if (item.type == "tar"){
                            dictionary.solid ++;
                            dictionary.pedanticsolid ++;
                        }
                        if (item.type == "killu" && object.shieldDuration > 0){ // When shielded, everything becomes Solid. This works for any shielded object.
                            dictionary.solid ++;
                            dictionary.pedanticsolid ++;
                            dictionary.killu --;
                        }
                        if (item == this.player){
                            dictionary.all ++;
                        }
                        if (item.type == "sensor"){
                            if (object == this.player && !item.options.toggle){
                                item.options.toggle = true;
                            }
                        }
                    }
                    else if (!this.probPassers.includes(object)){
                        this.probPassers.push(object);
                    }
                }
            }
        });
        if (passers == 0 && this.probPassers.includes(object)){
            this.probPassers = this.probPassers.filter(function(value, index, arr){
                return value == object;
            });
        }
        if (this.player.shieldDuration > 0){
            this.bricks.pop();
        }
        this.bricks.forEach((item, i) => {
            if (item.type == "sensor" && object == this.player){
                if (dictionary.elements.indexOf(item) == -1){
                    if (item.options.toggle){
                        item.options.toggle = false;
                        if (item.options.state == undefined){ // Safeguard
                            item.options.state = true;
                        }
                        item.options.state = !item.options.state;
                        item.options.comrades.forEach((comrade) => {
                            comrade.options.state = item.options.state;
                        });
                        if (!Array.isArray(item.options.slave)){
                            item.options.slave = [item.options.slave];
                        }
                        item.options.slave.forEach((slave) => {
                            if (item.options.state){
                                slave.element.classList.remove("transparent");
                            }
                            else{
                                //console.log(slave);
                                slave.element.classList.add("transparent");
                            }
                        });
                    }
                }
            }
        });
        return dictionary;
    }
    horizontalBetween(object, object2 = this.player){
        var isBetween = false;
        this.bricks.forEach((item, i) => {
            if (item != object && item != object2){
                var val1 = item.y1 - object.y1;
                var val2 = item.y1 - object2.y1;
                if (val1 * val2 < 0){
                    if ((item.x2 > object.x1 && item.x1 < object.x2) ||
                        (item.x2 > object2.x1 && item.x1 < object2.x2)){
                        isBetween = true;
                    }
                }
            }
        });
        return isBetween;
    }

    verticalBetween(object, object2 = this.player){
        var isBetween = false;
        this.bricks.forEach((item, i) => {
            if (item != object && item != object2){
                var val1 = item.x1 - object.x1;
                var val2 = item.x1 - object2.x1;
                if (val1 * val2 < 0){
                    if ((item.y2 > object.y1 && item.y1 < object.y2) ||
                        (item.y2 > object2.y1 && item.y1 < object2.y2)){
                        isBetween = true;
                    }
                }
            }
        });
        return isBetween;
    }

    run(){
        if (this.die || this.win){
            document.getElementById("game-main").classList.remove("playing");
            if (this.win){
                document.getElementById("gamewin").style.display="block";
                document.getElementById("gamewin").innerText = "You beat the level! Your score: " + this.player.score;
                window.gm.beat();
            }
            if (this.die){
                document.getElementById("gameover").style.display="block";
            }
            window.removeEventListener('keydown', this.onkeydown);
            window.removeEventListener("keyup", this.onkeyup);
            this.bricks.forEach((item, i) => {
                item.remove();
                item = null;
            });
            this.specials.forEach((item, i) => {
                item = null;
            });
            this.player.remove();
            this.bricks = null;
            this.specials = null;
            this.player = null;
            setTimeout(() => {
                document.getElementById("gameover").style.display="none";
                document.getElementById("gamewin").style.display="none";
                document.getElementById("menu").style.display="";
            }, 2000);
            return true;
        }
        if (this.minigamePlaying){
            var city = this.minigames[this.minigamePlaying](this.minigame, this.minigameTick); // Should return 0 or any other falsey number if no effect, 1 if the player wins, 2 if the player loses.
            if (city == 1){
                 this.minigame.style.display = "none";
                 this.minigamePlaying = false;
            }
            else if (city == 2){
                minigameActiveBlock = this.minigameActiveBlock.element;
                this.minigameActiveBlock.parentNode.removeChild(this.minigameActiveBlock);
                this.bricks = this.bricks.filter(item => item !== this.minigameActiveBlock);
            }
            this.minigameTick ++;
        }
        else{
            this.player.run();
            this.apply();
        }
        if (this.runningEnemies){
            var die = [];
            this.specials.forEach((item, i) => {
                if (item.type == "normal"){
                    item.yv ++;
                    item.brick.move(0, item.yv);
                    if (this.checkCollision(item.brick, true, true)["all"] > 1){
                        while (this.checkCollision(item.brick, true, true)["all"] > 1){
                            item.brick.move(0, -Math.abs(item.yv)/item.yv);
                        }
                        item.yv = 0;
                    }
                    for (var i = 0; i < Math.abs(item.speed); i ++){
                        item.brick.move(Math.abs(item.speed)/item.speed, 0);
                        var coll = this.checkCollision(item.brick, true);
                        if (coll["elevator"] > 0){
                            item.yv = -20;
                        }
                        if (coll["bigElevator"] > 0){
                            item.yv = -40;
                        }
                        if (coll["all"] > 1){
                            while (this.checkCollision(item.brick, true)["all"] > 1){
                                item.brick.move(-Math.abs(item.speed)/item.speed, 0);
                            }
                            item.speed *= -1;
                        }
                    }
                }
                else if (item.type == "bat"){
                    if (!(this.verticalBetween(item.brick) || this.horizontalBetween(item.brick))){
                        item.active = true;
                    }
                    if (item.active){ // It's undefined until it's true, ya know?
                        item.yv ++;
                        item.brick.move(0, item.yv);
                        if (this.checkCollision(item.brick, true, true)["all"] > 1){
                            while (this.checkCollision(item.brick, true, true)["all"] > 1){
                                item.brick.move(0, -Math.abs(item.yv)/item.yv);
                            }
                            item.yv = 0;
                            item.type = "flyer";
                            item.brick.element.classList.add("bat-active");
                        }
                        item.brick.move(0, item.yv);
                    }
                }
                else if (item.type == "flyer"){
                    if (item.limit > 0){
                        item.limit --;
                        if (item.limit == 0){
                            console.log("Deleting " + i);
                            die.push(item);
                        }
                    }
                    if (this.player.y2 < item.brick.y1){
                        item.yv --;
                    }
                    else if (this.player.y1 > item.brick.y2){
                        item.yv ++;
                    }
                    if (this.player.x2 < item.brick.x1){
                        item.speed --;
                    }
                    else if (this.player.x1 > item.brick.x2){
                        item.speed ++;
                    }
                    item.speed *= 0.9;
                    item.brick.move(0, item.yv);
                    if (this.checkCollision(item.brick, true, true)["all"] > 1){
                        while (this.checkCollision(item.brick, true, true)["all"] > 1){
                            item.brick.move(0, -Math.abs(item.yv)/item.yv);
                        }
                        item.yv = 0;
                    }
                    for (var i = 0; i < Math.abs(item.speed); i ++){
                        item.brick.move(Math.abs(item.speed)/item.speed, 0);
                        var coll = this.checkCollision(item.brick, true);
                        if (coll["elevator"] > 0){
                            item.yv = -20;
                        }
                        if (coll["bigElevator"] > 0){
                            item.yv = -40;
                        }
                        if (coll["all"] > 1){
                            while (this.checkCollision(item.brick, true)["all"] > 1){
                                item.brick.move(-Math.abs(item.speed)/item.speed, 0);
                            }
                            item.speed *= -1;
                        }
                    }
                }
                else if (item.type == "gunner"){
                    if (item.phase == undefined){
                        item.phase = 0;
                    }
                    item.phase ++;
                    if (!(this.verticalBetween(item.brick) || this.horizontalBetween(item.brick)) && item.phase > 75){
                        item.phase = 0;
                        this.specials.push({
                            type: "flyer",
                            brick: this.createBrick(item.mkx + (this.x / 50), item.mky + (this.y/50) - 1, 0.3, 0.3, "bat", "killu"),
                            yv: -20,
                            speed: 0,
                            limit: 150
                        });
                    }
                }
                else if (item.type == "blaze"){
                    if (item.phase == undefined){
                        item.phase = 0;
                    }
                    if (item.sputterperiod == undefined){
                        item.sputterperiod = 0;
                    }
                    item.phase ++;
                    item.sputterperiod ++;
                    if (item.sputterperiod > item.spurtLength + item.spurtSpacing){
                        item.sputterperiod = 0;
                    }
                    if (!(this.verticalBetween(item.brick) || this.horizontalBetween(item.brick)) && item.phase > item.phaseLength && item.sputterperiod < item.spurtLength){
                        item.phase = 0;
                        this.specials.push({
                            type: "flyer",
                            brick: this.createBrick(item.mkx + (this.x / 50) + 0.5, item.mky + (this.y/50) - 0.5, 0.3, 0.3, "lava", "killu"),
                            yv: (Math.random() * 10) - 20,
                            speed: (Math.random() * 20) - 10,
                            limit: item.lifetime + 20
                        });
                        this.specials.push({
                            type: "flyer",
                            brick: this.createBrick(item.mkx + (this.x / 50), item.mky + (this.y/50) - 0.5, 0.3, 0.3, "lava", "killu"),
                            yv: (Math.random() * 10) - 20,
                            speed: (Math.random() * 20) - 10,
                            limit: item.lifetime
                        });
                        this.specials.push({
                            type: "flyer",
                            brick: this.createBrick(item.mkx + (this.x / 50) + 1, item.mky + (this.y/50) - 0.5, 0.3, 0.3, "lava", "killu"),
                            yv: (Math.random() * 10) - 20,
                            speed: (Math.random() * 20) - 10,
                            limit: item.lifetime
                        });
                    }
                }
                else if (item.type == "bomb"){
                    item.yv ++;
                    item.brick.move(0, item.yv);
                    if (this.checkCollision(item.brick, true, true)["solid"] > 0){
                        while (this.checkCollision(item.brick, true, true)["solid"] > 0){
                            item.brick.move(0, -Math.abs(item.yv)/item.yv);
                        }
                        item.yv = 0;
                    }
                    item.timeLeft --;
                    if (item.timeLeft == 0){
                        item.brick.element.classList.add("explode");
                    }
                    if (item.timeLeft == -50){
                        die.push(item);
                        this.specials.forEach((item2, i2) => {
                            if (item2.type == "normal" || item2.type == "flyer"){
                                console.log(item2);
                                var x2 = item.brick.x2 + 5 * this.brickWidth;
                                var x1 = item.brick.x1 - 5 * this.brickWidth;
                                var y2 = item.brick.y2 + 5 * this.brickHeight;
                                var y1 = item.brick.y1 - 5 * this.brickHeight;
                                if (x2 > item2.brick.x1 &&
                                    x1 < item2.brick.x2 &&
                                    y2 > item2.brick.y1 &&
                                    y1 < item2.brick.y2){
                                    die.push(item2);
                                }
                            }
                        });
                    }
                }
            });
            die.forEach((item, i) => {
                var x = this.specials.indexOf(item);
                this.specials[x].brick.remove();
                this.bricks.splice(this.bricks.indexOf(this.specials[x].brick), 1);
                this.specials.splice(x, 1);
            });
        }
        this.endings.forEach((item, i) => {
            if (this.keysCount > 0){
                item.element.style.opacity = "0.3";
            }
            else {
                item.element.style.opacity = "";
                this.unstables.forEach((item, i) => {
                    this.unstables[0].remove();
                    this.bricks.splice(this.bricks.indexOf(this.unstables[0]), 1);
                    this.unstables.splice(0, 1);
                });
            }
        });
    }

    registerMinigame(name, play){ // Register minigame functions. All should take the element to draw on (dynamic!), play should also take the tick value.
        this.minigames[name] = play;
    }

    playMinigame(name){
        this.minigame.style.display = "block";
        this.minigamePlaying = name;
        this.minigameTick = 0;
    }
    toggleEnemies(){
        this.runningEnemies = !this.runningEnemies;
    }
}


class GameManager{
    constructor(phases){
        this.phases = phases;
        if (window.localStorage.localSettings == undefined){
            console.log("No local settings. Creating a localSettings profile now.");
            window.localStorage["localSettings"] = JSON.stringify({
                games: [],
                topGameID: 0
            });
        }
        this.proxyValidator = {
            gameManager: this,
            set(obj, prop, value){
                obj[prop] = value;
                window.localStorage["localSettings"] = JSON.stringify(this.gameManager.settings);
                return true;
            },
            get(obj, prop){
                return (typeof(obj[prop]) == "object" ? (new Proxy(obj[prop], this.gameManager.proxyValidator)) : obj[prop]);
            }
        };

        this._settings = JSON.parse(window.localStorage["localSettings"]);
        this.settings = new Proxy(this._settings, this.proxyValidator);
        if (this.settings.games.length == 0){
            this.newGame("Default");
        }
        this.game = null;
        this.curGameIndex = 0;
        this.levelsRemaining = -1;
    }

    newGame(gameName){
        this.settings.games.push({
            name: gameName,
            phase: 0,
            id: this.settings.topGameID
        });
        this.settings.topGameID ++;
    }

    displayGameMenu(){
        var gamesDropdownEl = document.querySelector("#gameselectDropdown");
        gamesDropdownEl.innerHTML = "";
        gamesDropdownEl.addEventListener("change", (event) => {
            this.loadLevels();
        });
        this.settings.games.forEach((item, i) => {
            var el = document.createElement("option");
            el.innerHTML = item.name;
            el.id = item.id;
            gamesDropdownEl.appendChild(el);
        });
        this.loadLevels();
    }

    getCurrentPhase(getCurrentGame = false){
        var dropdown = document.querySelector("#gameselectDropdown");
        var id = dropdown.options[dropdown.options.selectedIndex].id;
        var ret = undefined;
        this.settings.games.forEach((item, i) => {
            if (item.id == id){
                if (getCurrentGame){
                    ret = [item.phase, item.id];
                }
                else{
                    ret = item.phase;
                }
            }
        });
        return ret;
    }

    loadLevels(){
        var dropdown = document.querySelector("#dropdown");
        dropdown.innerHTML = "";
        this.phases[this.getCurrentPhase()].forEach((item, i) => {
            var el = document.createElement("option");
            el.innerHTML = item.name;
            el.id = item.id;
            dropdown.appendChild(el);
        });
        this.levelsRemaining = this.phases[this.getCurrentPhase()].length;
        this.curGameIndex = this.getCurrentPhase(true)[1];
    }

    createLevel(){
        var dropdown = document.querySelector("#dropdown");
        var id = dropdown.options[dropdown.options.selectedIndex].id;
        this.phases[this.getCurrentPhase()].forEach((item, i) => {
            if (item.id == id){
                item.func(this.game);
            }
        });
    }

    play(){
        this.game = new Game(false);
        window.game = this.game;

        this.createLevel();

        document.getElementById("menu").style.display="none";
        Array.from(document.getElementsByClassName("tencoin")).forEach((item, i) => {
            item.innerHTML="<p class='coin_text'>10</p>";
        });
        Array.from(document.getElementsByClassName("fiftycoin")).forEach((item, i) => {
            item.innerHTML="<p class='coin_text big'>50</p>";
        });
    }

    run(){
        return this.game.run();
    }

    beat(){
        this.levelsRemaining --;
        var dropdown = document.querySelector("#dropdown");
        var variab = dropdown.options[dropdown.options.selectedIndex];
        variab.parentNode.removeChild(variab);
        if (this.levelsRemaining == 0){
            this.settings.games[this.curGameIndex].phase ++;
            if (this.settings.games[this.curGameIndex].phase >= this.phases.length){
                document.getElementById("gamebeat").style.display = "";
                document.getElementById("gamewin").style.display = "none"; // Stop it from rendering that one.
                setInterval(function(){
                    document.getElementById("gamebeat").style.display = "none";
                }, 2000);
                this.settings.games[this.curGameIndex].phase = 0;
            }
            this.loadLevels();
            this.game = undefined; // Undef it!
            window.game = undefined;
        }
    }
}


var gm = new GameManager(window.phases);
gm.displayGameMenu();


document.getElementById("playbutton").addEventListener("click",function(){
    /*if (!document.querySelector("#multiplayerCheckbox > input").checked)
        g=new Game(document.querySelector("#mobileOrNot > input").checked);//, PrivateTestRobot);//, TrainingRobot);
        window.levelMakerContext = getLevelmakerContext(g);

        window.phases[window.phase - 1].forEach((item, i) => {
            if (item.id == document.querySelector("#levelselect > select").value){
                item.func();
            }
        });
    }
    else{
        g = new Game(document.querySelector("#mobileOrNot > input".checked), true);
    }*/
    gm.play();
    var fun = function(){
        if (!gm.run()){
            window.requestAnimationFrame(fun);
        }
    }
    window.requestAnimationFrame(fun);
});
